(function(e){function t(t){for(var n,a,u=t[0],i=t[1],c=t[2],d=0,p=[];d<u.length;d++)a=u[d],Object.prototype.hasOwnProperty.call(s,a)&&s[a]&&p.push(s[a][0]),s[a]=0;for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n]);f&&f(t);while(p.length)p.shift()();return o.push.apply(o,c||[]),r()}function r(){for(var e,t=0;t<o.length;t++){for(var r=o[t],n=!0,a=1;a<r.length;a++){var u=r[a];0!==s[u]&&(n=!1)}n&&(o.splice(t--,1),e=i(i.s=r[0]))}return e}var n={},a={app:0},s={app:0},o=[];function u(e){return i.p+"js/"+({}[e]||e)+"."+{"chunk-93ce8030":"8749077d"}[e]+".js"}function i(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.e=function(e){var t=[],r={"chunk-93ce8030":1};a[e]?t.push(a[e]):0!==a[e]&&r[e]&&t.push(a[e]=new Promise((function(t,r){for(var n="css/"+({}[e]||e)+"."+{"chunk-93ce8030":"01d5dc1d"}[e]+".css",s=i.p+n,o=document.getElementsByTagName("link"),u=0;u<o.length;u++){var c=o[u],d=c.getAttribute("data-href")||c.getAttribute("href");if("stylesheet"===c.rel&&(d===n||d===s))return t()}var p=document.getElementsByTagName("style");for(u=0;u<p.length;u++){c=p[u],d=c.getAttribute("data-href");if(d===n||d===s)return t()}var f=document.createElement("link");f.rel="stylesheet",f.type="text/css",f.onload=t,f.onerror=function(t){var n=t&&t.target&&t.target.src||s,o=new Error("Loading CSS chunk "+e+" failed.\n("+n+")");o.code="CSS_CHUNK_LOAD_FAILED",o.request=n,delete a[e],f.parentNode.removeChild(f),r(o)},f.href=s;var g=document.getElementsByTagName("head")[0];g.appendChild(f)})).then((function(){a[e]=0})));var n=s[e];if(0!==n)if(n)t.push(n[2]);else{var o=new Promise((function(t,r){n=s[e]=[t,r]}));t.push(n[2]=o);var c,d=document.createElement("script");d.charset="utf-8",d.timeout=120,i.nc&&d.setAttribute("nonce",i.nc),d.src=u(e);var p=new Error;c=function(t){d.onerror=d.onload=null,clearTimeout(f);var r=s[e];if(0!==r){if(r){var n=t&&("load"===t.type?"missing":t.type),a=t&&t.target&&t.target.src;p.message="Loading chunk "+e+" failed.\n("+n+": "+a+")",p.name="ChunkLoadError",p.type=n,p.request=a,r[1](p)}s[e]=void 0}};var f=setTimeout((function(){c({type:"timeout",target:d})}),12e4);d.onerror=d.onload=c,document.head.appendChild(d)}return Promise.all(t)},i.m=e,i.c=n,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw e};var c=window["webpackJsonp"]=window["webpackJsonp"]||[],d=c.push.bind(c);c.push=t,c=c.slice();for(var p=0;p<c.length;p++)t(c[p]);var f=d;o.push([0,"chunk-vendors"]),r()})({0:function(e,t,r){e.exports=r("cd49")},"0613":function(e,t,r){"use strict";var n,a,s=r("8bbf"),o=r.n(s),u=r("5880"),i=r.n(u),c=(r("96cf"),r("1da1")),d="set_user",p="clear_user",f="set_token",g="set_mobile",h="set_background",m=r("48b8"),b=r("d54a").default,l=(r("3f4c").default,{register:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function r(){var n,a,s;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,r.next=4,b.register(t);case 4:if(a=r.sent,s=Object(m["g"])(a),!s){r.next=10;break}return n(d,s.user),n(f,s.token),r.abrupt("return",s);case 10:case"end":return r.stop()}}),r)})))()},login:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function r(){var n,a,s;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return n=e.commit,r.next=3,b.login(t);case 3:if(a=r.sent,s=Object(m["g"])(a),!s){r.next=10;break}return n(d,s.user),n(f,s.token),r.abrupt("return",s);case 10:case"end":return r.stop()}}),r)})))()}}),y=l,v=r("ade3"),w=r("a78e"),I=r.n(w),k=(n={},Object(v["a"])(n,d,(function(e,t){e.user=t,localStorage.setItem("user",JSON.stringify(t)),I.a.set("user",t,{expires:3650})})),Object(v["a"])(n,p,(function(e){e.user={userId:"",username:"",password:"",avatar:"",createTime:0,publicId:""},localStorage.setItem("user",""),I.a.set("user","")})),Object(v["a"])(n,f,(function(e,t){e.token=t,I.a.set("token",t,{expires:3})})),Object(v["a"])(n,g,(function(e,t){e.mobile=t})),Object(v["a"])(n,h,(function(e,t){e.background=t,localStorage.setItem("background",t)})),n),x=k,R={user:function(e){e.user;var t=I.a.get("user");return t=localStorage.getItem("user"),t?(e.user=JSON.parse(t),e.user):{}},mobile:function(e){return e.mobile},background:function(e){return e.background,localStorage.getItem("background")}},O=R,j={user:{userId:"",username:"",password:"",avatar:"",createTime:0,publicId:""},token:"",mobile:!1,background:""},T=j,S={namespaced:!0,state:T,mutations:x,actions:y,getters:O},M=S,G=(r("99af"),r("b85c")),A=r("8055"),U=r.n(A),_="set_socket",N="set_dropped",B="set_active_group_user",C="set_active_room",K="set_user_gather",P="set_friend_gather",q="set_group_gather",H="add_group_message",$="set_group_messages",F="add_friend_message",D="set_friend_messages",z="del_group",E="del_friend",L="set_unread_gather",J="lose_unread_gather",W=r("3fff"),X=r("cfbb"),V=r("21e1"),Z=r("5ab6"),Q=r("302f"),Y=r("a090").default,ee=(r("3f4c").default,{addGroup:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function r(){var n;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n=e.commit,e.state,e.dispatch,e.rootState,!t.code){r.next=4;break}return r.abrupt("return",o.a.prototype.$message.error(t.msg));case 4:o.a.prototype.$message.success(t.msg),n(q,t.data);case 7:case"end":return r.stop()}}),r)})))()},joinGroup:function(e,t){var r=e.commit,n=e.state,a=(e.dispatch,e.rootState),s=a.app.user;if(t.code)return o.a.prototype.$message.error(t.msg);var u=t.data.user,i=t.data.group;if(u.userId!=s.userId)return r(K,u),o.a.prototype.$message.info("".concat(u.username,"加入群").concat(i.groupName));n.groupGather[i.groupId]||(r(q,i),V["a"].getChatData(s)),o.a.prototype.$message.info("成功加入群".concat(i.groupName)),r(C,n.groupGather[i.groupId])},joinGroupSocket:function(e,t){var r=e.commit,n=e.state,a=(e.dispatch,e.rootState),s=a.app.user;if(t.code)return o.a.prototype.$message.error(t.msg);var u=t.data.user,i=t.data.group,c=n.friendGather;if(u.userId!=s.userId){var d;if(r(K,u),c[u.userId])c[u.userId].messages&&(d=c[u.userId].messages),r(P,u),r(D,d);if(window.msg===u.userId)return;return window.msg=u.userId,o.a.prototype.$message.info("".concat(u.username,"加入群").concat(i.groupName))}n.groupGather[i.groupId]||r(q,i),r(K,u)},activeGroupUser:function(e,t){var r=e.commit;e.state,e.dispatch,e.rootState;r(B,t.data)},groupMessage:function(e,t){var r=e.commit,n=e.state;e.dispatch,e.rootState;if(t.code)o.a.prototype.$message.error(t.msg);else{r(H,t.data);var a=n.activeRoom;a&&a.groupId!==t.data.groupId&&r(L,t.data.groupId)}},serviceMessage:function(e,t){e.commit,e.state;var r=e.dispatch;e.rootState;r("groupMessage",{code:Q["a"].OK,msg:"",data:{userId:"0",groupId:Z["a"].groupId,content:t,width:void 0,height:void 0,messageType:"text"}})},chatData:function(e,t){var r=e.commit,n=(e.state,e.dispatch);e.rootState;if(t.code)return o.a.prototype.$message.error(t.msg);n("handleChatData",t.data),r(N,!1)},connectSocket:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function t(){var r,n,a,s,u,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:r=e.commit,n=e.state,a=e.dispatch,s=e.rootState,u=s.app.user,Y.getAllData(u),i=U.a.connect("/?userId=".concat(u.userId),{reconnection:!0}),i.on("connect",Object(c["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:i.emit("chatData",u),r(_,i);case 3:case"end":return e.stop()}}),e)})))),i.on("activeGroupUser",(function(e){r(B,e.data)})),i.on("addGroup",(function(e){if(e.code)return o.a.prototype.$message.error(e.msg);o.a.prototype.$message.success(e.msg),r(q,e.data)})),i.on("joinGroup",function(){var e=Object(c["a"])(regeneratorRuntime.mark((function e(t){var a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!t.code){e.next=3;break}return e.abrupt("return",o.a.prototype.$message.error(t.msg));case 3:if(a=t.data.user,s=t.data.group,a.userId==u.userId){e.next=10;break}return r(K,a),e.abrupt("return",o.a.prototype.$message.info("".concat(a.username,"加入群").concat(s.groupName)));case 10:n.groupGather[s.groupId]||(r(q,s),i.emit("chatData",u)),o.a.prototype.$message.info("成功加入群".concat(s.groupName)),r(C,n.groupGather[s.groupId]);case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),i.on("joinGroupSocket",(function(e){if(e.code)return o.a.prototype.$message.error(e.msg);var t=e.data.user,a=e.data.group,s=n.friendGather;if(t.userId!=u.userId){var i;if(r(K,t),s[t.userId])s[t.userId].messages&&(i=s[t.userId].messages),r(P,t),r(D,i);if(window.msg===t.userId)return;return window.msg=t.userId,o.a.prototype.$message.info("".concat(t.username,"加入群").concat(a.groupName))}n.groupGather[a.groupId]||r(q,a),r(K,t)})),i.on("groupMessage",(function(e){if(e.code)o.a.prototype.$message.error(e.msg);else{r(H,e.data);var t=n.activeRoom;t&&t.groupId!==e.data.groupId&&r(L,e.data.groupId)}})),i.on("addFriend",(function(e){e.code?o.a.prototype.$message.error(e.msg):(r(P,e.data),r(K,e.data),o.a.prototype.$message.info(e.msg),i.emit("joinFriendSocket",{userId:u.userId,friendId:e.data.userId}))})),i.on("joinFriendSocket",(function(e){e.code})),i.on("friendMessage",(function(e){if(e.code)o.a.prototype.$message.error(e.msg);else if(e.data.friendId===u.userId||e.data.userId===u.userId){r(F,e.data);var t=n.activeRoom;t&&t.userId!==e.data.userId&&t.userId!==e.data.friendId&&r(L,e.data.userId)}})),i.on("chatData",(function(e){if(e.code)return o.a.prototype.$message.error(e.msg);a("handleChatData",e.data),r(N,!1)})),i.on("exitGroup",(function(e){e.code?o.a.prototype.$message.error(e.msg):(r(z,e.data),r(C,n.groupGather[W["b"]]),o.a.prototype.$message.success(e.msg))})),i.on("exitFriend",(function(e){e.code?o.a.prototype.$message.error(e.msg):(r(E,e.data),r(C,n.groupGather[W["b"]]),o.a.prototype.$message.success(e.msg))}));case 17:case"end":return t.stop()}}),t)})))()},handleChatData:function(e,t){return Object(c["a"])(regeneratorRuntime.mark((function r(){var n,a,s,o,u,i,c,d,p,f,g,h,m,b,l,y,v,w,I,k,x;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n=e.commit,e.dispatch,a=e.state,s=e.rootState,o=s.app.user,u=a.socket,i=a.groupGather,c=t.groupData,d=t.friendData,p=t.userData,c.length){f=Object(G["a"])(c);try{for(f.s();!(g=f.n()).done;)h=g.value,X["a"].joinGroupSocket({groupId:h.groupId,userId:o.userId}),n(q,h)}catch(R){f.e(R)}finally{f.f()}}if(d.length){m=Object(G["a"])(d);try{for(m.s();!(b=m.n()).done;)l=b.value,u.emit("joinFriendSocket",{userId:o.userId,friendId:l.userId}),n(P,l)}catch(R){m.e(R)}finally{m.f()}}if(p.length){y=Object(G["a"])(p);try{for(y.s();!(v=y.n()).done;)w=v.value,n(K,w)}catch(R){y.e(R)}finally{y.f()}}if(I=a.activeRoom,k=a.groupGather,x=a.friendGather,I){r.next=15;break}return r.abrupt("return",n(C,i[W["b"]]));case 15:n(C,k[I.groupId]||x[I.userId]);case 16:case"end":return r.stop()}}),r)})))()}}),te=ee,re=(r("07ac"),a={},Object(v["a"])(a,_,(function(e,t){e.socket=t})),Object(v["a"])(a,N,(function(e,t){e.dropped=t})),Object(v["a"])(a,B,(function(e,t){e.activeGroupUser=t;for(var r=e.userGather,n=0,a=Object.values(t[W["b"]]);n<a.length;n++){var s=a[n];o.a.set(r,s.userId,s)}})),Object(v["a"])(a,H,(function(e,t){e.groupGather[t.groupId].messages?e.groupGather[t.groupId].messages.push(t):o.a.set(e.groupGather[t.groupId],"messages",[t])})),Object(v["a"])(a,$,(function(e,t){t&&t.length&&o.a.set(e.groupGather[t[0].groupId],"messages",t)})),Object(v["a"])(a,F,(function(e,t){var r=this.getters["app/user"].userId;t.friendId===r?e.friendGather[t.userId].messages?e.friendGather[t.userId].messages.push(t):o.a.set(e.friendGather[t.userId],"messages",[t]):e.friendGather[t.friendId].messages?e.friendGather[t.friendId].messages.push(t):o.a.set(e.friendGather[t.friendId],"messages",[t])})),Object(v["a"])(a,D,(function(e,t){var r=this.getters["app/user"].userId;t&&t.length&&(t[0].friendId===r?o.a.set(e.friendGather[t[0].userId],"messages",t):o.a.set(e.friendGather[t[0].friendId],"messages",t))})),Object(v["a"])(a,C,(function(e,t){e.activeRoom=t})),Object(v["a"])(a,q,(function(e,t){o.a.set(e.groupGather,t.groupId,t)})),Object(v["a"])(a,K,(function(e,t){o.a.set(e.userGather,t.userId,t)})),Object(v["a"])(a,P,(function(e,t){o.a.set(e.friendGather,t.userId,t)})),Object(v["a"])(a,z,(function(e,t){o.a.delete(e.groupGather,t.groupId)})),Object(v["a"])(a,E,(function(e,t){o.a.delete(e.friendGather,t.friendId)})),Object(v["a"])(a,L,(function(e,t){e.unReadGather[t]?++e.unReadGather[t]:o.a.set(e.unReadGather,t,1)})),Object(v["a"])(a,J,(function(e,t){o.a.set(e.unReadGather,t,0)})),a),ne=re,ae={socket:function(e){return e.socket},dropped:function(e){return e.dropped},activeGroupUser:function(e){return e.activeGroupUser},activeRoom:function(e){return e.activeRoom},groupGather:function(e){return e.groupGather},friendGather:function(e){return e.friendGather},userGather:function(e){return e.userGather},unReadGather:function(e){return e.unReadGather}},se=ae,oe={socket:null,dropped:!1,activeGroupUser:{},activeRoom:null,groupGather:{},userGather:{},friendGather:{},unReadGather:{}},ue=oe,ie={namespaced:!0,state:ue,mutations:ne,actions:te,getters:se},ce=ie;o.a.use(i.a);var de={app:M,chat:ce};t["a"]=new i.a.Store({modules:de})},1:function(e,t){},10:function(e,t){},11:function(e,t){},12:function(e,t){},13:function(e,t){},14:function(e,t){},15:function(e,t){},"15a6":function(e,t,r){"use strict";r("4dec");t["a"]={roomObjects:{},user:{username:"",userId:""},groupMessageRepository:{},db:{},hasInit:!1,web3:{},interval:{},iterations:0}},16:function(e,t){},17:function(e,t){},18:function(e,t){},19:function(e,t){},2:function(e,t){},20:function(e,t){},21:function(e,t){},"21e1":function(e,t,r){"use strict";r("3f4c");var n=r("a090"),a=r("0613");r("302f");t["a"]={refreshChatData:function(e){a["a"].dispatch("chat/chatData",e)},getChatData:function(e){n["default"].getAllData(e)}}},22:function(e,t){},23:function(e,t){},24:function(e,t){},25:function(e,t){},26:function(e,t){},27:function(e,t){},28:function(e,t){},29:function(e,t){},3:function(e,t){},30:function(e,t){},"302f":function(e,t,r){"use strict";var n;r.d(t,"a",(function(){return n})),function(e){e[e["OK"]=0]="OK",e[e["FAIL"]=1]="FAIL",e[e["ERROR"]=2]="ERROR"}(n||(n={}))},31:function(e,t){},32:function(e,t){},33:function(e,t){},34:function(e,t){},35:function(e,t){},36:function(e,t){},37:function(e,t){},38:function(e,t){},39:function(e,t){},"3f4c":function(e,t,r){"use strict";r.r(t),function(e){r("99af"),r("4de4"),r("7db0"),r("c975"),r("d81d"),r("b0c0"),r("d3b7"),r("07ac"),r("ac1f"),r("25f0"),r("3ca3"),r("1276"),r("498a"),r("ddb0"),r("2b3d");var n,a=r("ade3"),s=r("3835"),o=r("b85c"),u=(r("96cf"),r("1da1")),i=(r("99e5"),r("cfbb")),c=r("a090"),d=r("f71c"),p=r("85e5"),f=r("e582"),g=r("5b74"),h=r("15a6"),m=r("4dec"),b=(r("0613"),r("302f")),l=(r("5ab6"),r("e532")),y=r("739d"),v=r("6467"),w=r("ad2b"),I=r.n(w),k=(r("94f8"),r("a002"),void 0),x=function(e,t){var r=e.query.userName;GROUP_USER.findGroupByUserName(r).then((function(e){return t.json({status:2e3,data:e,msg:"获取群聊成功"})})).catch((function(e){return t.json({status:2003,data:e,msg:"服务端错误，请稍后重试！"})}))},R=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.userId,s=n.groupIds,e.next=4,GROUP_USER.find({groupId:{$in:s},userId:a}).populate("groupId");case 4:return o=e.sent,e.abrupt("return",r.json({status:2e3,data:o,msg:"获取成功！"}));case 7:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),O=function(e,t){var r=e.query.id;GROUP.find({_id:r}).then((function(e){if(!e.length)return t.json({status:2001,data:"",msg:"未获取到群聊信息"});GROUP_USER.findGroupUsersByGroupId(r).then((function(r){return t.json({status:2e3,data:{group:e,users:r},msg:"获取群聊详情成功"})}))})).catch((function(e){return t.json({status:2003,data:e,msg:"服务端错误，请稍后重试！"})}))},j=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,o,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:n=t.query,a=n.type,s=n.q,o=n.page,u=n.pageSize,GROUP.searchGroup(a,s,o,u).then((function(e){return r.json({status:2e3,data:e,msg:"success"})})).catch((function(e){return r.json({status:2003,data:e,msg:"服务器错误，请稍后重试！"})}));case 2:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),T=function(e){var t=e.userId,r=e.groupId,n=e.userName;GROUP_USER.findOne({userId:t,groupId:r}).then((function(t){t||GROUP_USER.insertMany(e).then((function(e){GROUP.update({_id:r},{$inc:{userNum:1}});var t={roomid:r,message:"".concat(n,"加入群聊"),messageType:"sys",isReadUser:[]};insertNewGroupNews(t)}))})).catch((function(e){return res.json({status:2003,data:e,msg:"服务器错误，请稍后重试！"})}))},S=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,GROUP.find().populate({path:"holderUserId",select:"nickname photo signature"});case 2:return n=e.sent,e.abrupt("return",r.json({status:2e3,data:n,msg:"获取成功！"}));case 4:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),M=function(){var t=Object(u["a"])(regeneratorRuntime.mark((function t(r){var n,a,s,o,u,c,d,p,g,m;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=h["a"].web3,t.next=4,h["a"].db.groupRepository.where({groupName:r.groupName}).first();case 4:if(a=t.sent,!a){t.next=8;break}return i["a"].clientAddgroup({code:b["a"].FAIL,msg:"该群名字已存在",data:a}),t.abrupt("return");case 8:if(Object(l["a"])(r.groupName)){t.next=10;break}return t.abrupt("return");case 10:s=n.eth.accounts.create(),o=e.from(s.address+s.address+s.address+s.address,"utf-8"),u=v["a"].createIdentity(o),r.groupId=u.address,r.adminPrivateKey=s.privateKey,r.privateKey=u.privateKey,c=h["a"].web3.eth.accounts.hashMessage(u.privateKey),r.SDPpassword=c,r.autoDownloadSize=1e7,$(r.groupId),d={groupId:r.groupId,userId:r.userId,groupName:r.groupName,createTime:(new Date).valueOf()},p={username:h["a"].user.username,userId:h["a"].user.userId,avatar:""},g={},g.messageType="admin",g.time=d.createTime-1,g.content={type:"setOwner",userId:r.userId},g.preHash="",g.hash=h["a"].web3.eth.accounts.hashMessage(g.preHash+g.groupId+g.content+g.time),m=h["a"].web3.eth.accounts.sign(g.hash,h["a"].user.privateKey),g.signature=m.signature,h["a"].db.groupRepository.add(r),h["a"].db.groupUserRepository.add({groupId:r.groupId,userId:r.userId}),f["a"].generateGenesisBlock(s,u,d,p,g),i["a"].clientAddgroup({code:b["a"].OK,msg:"成功创建群".concat(r.groupName),data:d}),D(),t.next=40;break;case 39:k.server.to(r.userId).emit("addGroup",{code:b["a"].FAIL,msg:"你没资格创建群"});case 40:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),G=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,h["a"].db.groupRepository.where({groupId:t.groupId}).first();case 3:return r=e.sent,e.next=6,h["a"].db.userRepository.where({userId:t.userId}).first();case 6:n=e.sent,$(t.groupId),a={group:r,user:n},i["a"].clientJoinGroupSocket({code:b["a"].OK,msg:"".concat(n.username,"加入群").concat(r.groupName),data:a});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),A=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,s,o,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:for(t.groupName="",r=t.groupId.split("&"),n=0;n<r.length-2;n++)t.groupName+=r[n];return t.privateKey=r[r.length-1],t.groupId=r[r.length-2],a={groupId:t.groupId,groupName:t.groupName,privateKey:t.privateKey},e.next=11,h["a"].db.groupUserRepository.where({groupId:a.groupId,userId:t.userId}).first();case 11:if(s=e.sent,o=h["a"].user,!a||!o){e.next=33;break}if(s){e.next=27;break}return t.groupId=a.groupId,e.next=20,h["a"].db.groupUserRepository.toArray();case 20:return e.sent,h["a"].db.groupRepository.add({groupId:t.groupId,groupName:t.groupName,privateKey:t.privateKey,createTime:Date.now(),autoDownloadSize:1e7}),e.next=25,h["a"].db.groupUserRepository.add({groupId:t.groupId,userId:t.userId});case 25:s=e.sent;case 27:u={group:a,user:o},i["a"].clientJoinGroup({code:b["a"].OK,msg:"".concat(o.username,"加入群").concat(a.groupName),data:u}),D(),e.next=34;break;case 33:i["a"].clientJoinGroup({code:b["a"].FAIL,msg:"进群失败",data:""});case 34:e.next=37;break;case 36:i["a"].clientJoinGroup({code:b["a"].FAIL,msg:"你没资格进群"});case 37:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),U=function(e,t,r,n){if("failed"!=n.content&&h["a"].roomObjects[e].deliverFile[n.content.hash]){var a=new Blob([t],{type:n.content.type}),s=new File([a],n.content.name,{type:n.content.type}),o=new I.a;h["a"].roomObjects[e].uploadClients.push(o),h["a"].roomObjects[e].clients.push(o),o.seed(s,null,function(){var t=Object(u["a"])(regeneratorRuntime.mark((function t(r){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:r.infoHash==n.content.hash&&(h["a"].db.fileRepository.put({hash:n.content.hash,type:"blob",blob:a,time:n.content.time,access:e,name:n.content.name}),h["a"].roomObjects[e].deliverFile[n.content.hash](r.files[0]));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},_=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t,r,n,a){var s,i,c,d,g,m,b,l,y,v,w,k,x;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:e.t0=r.messageType,e.next="fetchRecentSkeleton"===e.t0?3:"fetchAllBlocks"===e.t0?5:"fetchAncestorNeighbors"===e.t0?7:"fetchBlockByNumber"===e.t0?9:"fetchUser"===e.t0?11:"fetchFile"===e.t0?16:"file"===e.t0?31:"info"===e.t0?32:"user"===e.t0?33:"recentBlocks"===e.t0?34:"allBlocks"===e.t0?36:"block"===e.t0?38:"ancestorNeighbors"===e.t0?40:42;break;case 3:return f["a"].deliverRecentBlocksRequest(t,r.content,n),e.abrupt("break",42);case 5:return f["a"].deliverAllBlocksRequest(t,r.content,n),e.abrupt("break",42);case 7:return f["a"].deliverAncestorNeighborsRequest(t,r.content,n),e.abrupt("break",42);case 9:return f["a"].deliverBlockByNumberRequest(t,r.content,n),e.abrupt("break",42);case 11:return e.next=13,h["a"].db.userRepository.where({userId:r.content.userId}).first();case 13:return s=e.sent,s?h["a"].roomObjects[t].syncRequest({messageType:"user",content:s},n):h["a"].roomObjects[t].syncRequest({messageType:"user",content:"failed"},n),e.abrupt("break",42);case 16:return e.next=18,h["a"].db.fileRepository.where({hash:r.content.hash}).first();case 18:i=e.sent,c=new I.a,d=new Blob([i.blob],{type:r.content.type}),g=new File([d],r.content.name,{type:r.content.type}),c.seed(g,null,(function(e){})),m=p["a"].XOR(h["a"].web3.eth.accounts.hashMessage(h["a"].roomObjects[t].selfId),h["a"].web3.eth.accounts.hashMessage(r.content.hash)),b=1,l=Object(o["a"])(h["a"].roomObjects[t].room.getPeers());try{for(l.s();!(y=l.n()).done;)v=y.value,p["a"].leq(p["a"].XOR(h["a"].web3.eth.accounts.hashMessage(v),h["a"].web3.eth.accounts.hashMessage(r.content.hash)),m)&&b++}catch(R){l.e(R)}finally{l.f()}return b<4&&(i?"blob"==i.type&&h["a"].roomObjects[t].sendFile(i.blob,n,{messageType:"file",content:{hash:i.hash,type:i.blob.type,time:i.time,access:i.access,name:i.name}}):h["a"].roomObjects[t].syncRequest({messageType:"file",content:"failed"},n)),e.abrupt("break",42);case 31:r.content;case 32:return e.abrupt("break",42);case 33:"failed"!=r.content&&h["a"].roomObjects[t].deliverUser[r.content.userId](r.content);case 34:return f["a"].syncTasks[t].deliverRecentBlocks[n](r.content),e.abrupt("break",42);case 36:return f["a"].syncTasks[t].deliverAllBlocks[n](r.content),e.abrupt("break",42);case 38:return f["a"].syncTasks[t].deliverBlock[n](r.content),e.abrupt("break",42);case 40:return f["a"].syncTasks[t].deliverAncestorNeighbors[n](r.content),e.abrupt("break",42);case 42:if(a)switch(a.messageType){case"file":"failed"!=a.content&&h["a"].roomObjects[t].deliverFile[a.content.hash]&&(w=new Blob([r],{type:a.content.type}),k=new File([w],a.content.name,{type:a.content.type}),x=new I.a,h["a"].roomObjects[t].uploadClients.push(x),h["a"].roomObjects[t].clients.push(x),x.seed(k,null,function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:r.infoHash==a.content.hash&&(h["a"].db.fileRepository.put({hash:a.content.hash,type:"blob",blob:w,time:a.content.time,access:t,name:a.content.name}),h["a"].roomObjects[t].deliverFile[a.content.hash](r.files[0]));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()))}case 43:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}(),N=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t,r,n){var a,s,o,d,b,l,y,v,w,I,k,x,R,O;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r.userId==h["a"].user.userId){e.next=105;break}e.prev=3,a=h["a"].web3.eth.accounts.recover(r.hash,r.signature),e.next=11;break;case 7:return e.prev=7,e.t0=e["catch"](3),e.abrupt("return");case 11:if(r.userId=a,a==r.userId){e.next=16;break}return e.abrupt("return");case 16:if(r.groupId==t){e.next=19;break}return e.abrupt("return");case 19:if(r.hash==h["a"].web3.eth.accounts.hashMessage(r.preHash+r.groupId+r.content+r.time)){e.next=23;break}return e.abrupt("return");case 23:if(!(r.time>Date.now()+500)){e.next=28;break}return e.abrupt("return");case 28:return e.next=31,h["a"].db.groupRepository.where({groupId:t}).first();case 31:if(s=e.sent,"image"!=r.messageType){e.next=55;break}return e.next=35,h["a"].db.groupMessageRepository.where("[groupId+time]").between([t,m["a"].minKey],[t,m["a"].maxKey]).reverse().first();case 35:if(o=e.sent,o||(o={time:0}),h["a"].db.userRepository.where({userId:a}).first(function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r){e.next=5;break}return e.next=3,K(t,a);case 3:r=e.sent,r&&(h["a"].db.userRepository.add(r),c["default"].getAllData(h["a"].user));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),!r.dataURL){e.next=44;break}r.time>o.time?h["a"].db.groupMessageRepository.add(r).then((function(){f["a"].updateChain(t,r.time);var e={userId:r.userId,groupId:t,content:r.content,dataURL:r.dataURL,width:r.width,height:r.height,messageType:r.messageType,hash:r.hash};i["a"].receiveGroupMessage(e)})).catch((function(e){})):h["a"].db.groupMessageRepository.add(r).then((function(){f["a"].updateChain(t,r.time),c["default"].getAllData(h["a"].user)})).catch((function(e){})),e.next=49;break;case 44:return e.next=46,g["a"].fetchFile(r);case 46:return b=e.sent,e.next=49,b.getBlob((function(e,n){d=n;try{var a=new FileReader;d&&(a.readAsDataURL(d),a.onload=Object(u["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:r.dataURL=this.result,r.time>o.time?h["a"].db.groupMessageRepository.add(r).then((function(){f["a"].updateChain(t,r.time);var e={userId:r.userId,groupId:t,content:r.content,dataURL:r.dataURL,width:r.width,height:r.height,messageType:r.messageType,hash:r.hash};i["a"].receiveGroupMessage(e)})).catch((function(e){})):h["a"].db.groupMessageRepository.add(r).then((function(){f["a"].updateChain(t,r.time),c["default"].getAllData(h["a"].user)})).catch((function(e){}));case 4:case"end":return e.stop()}}),e,this)}))),a.onerror=function(){})}catch(s){}}));case 49:if(r.preHash==r.groupId){e.next=54;break}return e.next=52,h["a"].db.groupMessageRepository.where({hash:r.preHash}).first();case 52:l=e.sent,l||P({userId:h["a"].user.userId,groupId:t,content:{key:"hash",hash:r.preHash},messageType:"fetchOldMessage"});case 54:return e.abrupt("return");case 55:if("text"!=r.messageType){e.next=69;break}return e.next=58,h["a"].db.groupMessageRepository.where("[groupId+time]").between([t,m["a"].minKey],[t,m["a"].maxKey]).reverse().first();case 58:if(y=e.sent,y||(y={time:0}),h["a"].db.userRepository.where({userId:a}).first(function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r){e.next=5;break}return e.next=3,K(t,a);case 3:r=e.sent,r&&(h["a"].db.userRepository.add(r),c["default"].getAllData(h["a"].user));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),r.time>y.time?h["a"].db.groupMessageRepository.add(r).then((function(){f["a"].updateChain(t,r.time);var e="";e=s.privateKey?p["a"].decodeXOR(r.content,s.privateKey+r.time):r.content;var n={userId:r.userId,groupId:t,content:e,width:r.width,height:r.height,messageType:r.messageType,hash:r.hash};i["a"].receiveGroupMessage(n)})).catch((function(e){})):h["a"].db.groupMessageRepository.add(r).then((function(){f["a"].updateChain(t,r.time),c["default"].getAllData(h["a"].user)})).catch((function(e){})),r.preHash==r.groupId){e.next=68;break}return e.next=66,h["a"].db.groupMessageRepository.where({hash:r.preHash}).first();case 66:v=e.sent,v||P({userId:h["a"].user.userId,groupId:t,content:{key:"hash",hash:r.preHash},messageType:"fetchOldMessage"});case 68:return e.abrupt("return");case 69:if("file"!=r.messageType){e.next=91;break}return e.next=72,h["a"].db.groupMessageRepository.where("[groupId+time]").between([t,m["a"].minKey],[t,m["a"].maxKey]).reverse().first();case 72:return w=e.sent,w||(w={time:0}),e.next=76,h["a"].db.userRepository.where({userId:a}).first();case 76:if(I=e.sent,I){e.next=82;break}return e.next=80,K(t,a);case 80:I=e.sent,I&&(h["a"].db.userRepository.add(I),c["default"].getAllData(h["a"].user));case 82:if(r.time>w.time?h["a"].db.groupMessageRepository.add(r).then((function(){f["a"].updateChain(t,r.time);var e={userId:r.userId,groupId:t,content:r.content,width:r.width,height:r.height,messageType:r.messageType,hash:r.hash};i["a"].receiveGroupMessage(e)})).catch((function(e){})):h["a"].db.groupMessageRepository.add(r).then((function(){f["a"].updateChain(t,r.time),c["default"].getAllData(h["a"].user)})).catch((function(e){})),h["a"].db.groupRepository.where({groupId:r.groupId}).first((function(e){r.content.size&&r.content.size<e.autoDownloadSize&&g["a"].fetchFile(r)})),r.preHash==r.groupId){e.next=90;break}return e.next=88,h["a"].db.groupMessageRepository.where({hash:r.preHash}).first();case 88:k=e.sent,k||P({userId:h["a"].user.userId,groupId:t,content:{key:"hash",hash:r.preHash},messageType:"fetchOldMessage"});case 90:return e.abrupt("return");case 91:if("user"==r.messageType&&a==r.content.userId&&h["a"].db.userRepository.put(r.content),"fetchOldMessage"!=r.messageType){e.next=105;break}if("hash"!=r.content.key){e.next=99;break}return e.next=96,h["a"].db.groupMessageRepository.where({hash:r.content.hash}).first();case 96:x=e.sent,x={content:x.content,groupId:x.groupId,hash:x.hash,messageType:x.messageType,preHash:x.preHash,signature:x.signature,time:x.time,userId:x.userId},h["a"].roomObjects[r.groupId].sendMessage(x,h["a"].roomObjects[t].userIdsToIds[r.userId]);case 99:if("time"!=r.content.key){e.next=105;break}return e.next=102,h["a"].db.groupMessageRepository.where(["groupId","time"]).between([r.groupId,r.content.time[0]],[r.groupId,r.content.time[1]]).toArray();case 102:for(O in R=e.sent,R)delete R[O]._id,h["a"].roomObjects[r.groupId].sendMessage(R[O],h["a"].roomObjects[t].userIdsToIds[r.userId]);case 105:case"end":return e.stop()}}),e,null,[[3,7]])})));return function(t,r,n){return e.apply(this,arguments)}}(),B=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=new I.a,h["a"].roomObjects[t.groupId].clients.push(r),n=[["udp://tracker.openbittorrent.com:80"],["udp://tracker.internetwarriors.net:1337"],["udp://tracker.leechers-paradise.org:6969"],["udp://tracker.coppersurfer.tk:6969"],["udp://exodus.desync.com:6969"],["wss://tracker.webtorrent.io"],["wss://tracker.btorrent.xyz"],["wss://tracker.openwebtorrent.com"],["wss://tracker.fastcast.nz"]],n=n.map((function(e){return e[0]})).filter((function(e){return 0===e.indexOf("wss://")||0===e.indexOf("ws://")})),r.add(t.content.hash.trim(),{announce:n},(function(e){h["a"].roomObjects[t.groupId].deliverFile[t.content.hash](e.files[0])})),h["a"].roomObjects[t.groupId].syncRequest({userId:h["a"].user.userId,groupId:t.groupId,content:{hash:t.content.hash},messageType:"fetchFile"}),e.abrupt("return",new Promise((function(e,r){h["a"].roomObjects[t.groupId].deliverFile[t.content.hash]=e})));case 12:h["a"].roomObjects[t.groupId].uploadClient.add(t.content.hash);case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),C=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t,r,n){var a,s,u,i,c,d,f,g;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,h["a"].db.groupMessageRepository.where("[groupId+time]").between([t,m["a"].minKey],[t,m["a"].maxKey]).reverse().offset(r).limit(n).toArray();case 3:return a=e.sent,a=a.reverse(),e.next=7,h["a"].db.groupRepository.where({groupId:t}).first();case 7:s=e.sent,a.map((function(e){var t=e;return s.privateKey&&(t.content=p["a"].decodeXOR(t.content,s.privateKey+t.time)),t})),u={},i=[],c=Object(o["a"])(a),e.prev=12,c.s();case 14:if((d=c.n()).done){e.next=31;break}if(f=d.value,u[f.userId]){e.next=29;break}return e.next=20,h["a"].db.userRepository.where({userId:f.userId}).first();case 20:if(g=e.sent,!g){e.next=25;break}u[f.userId]=g,e.next=29;break;case 25:return e.next=27,K(t,f.userId);case 27:g=e.sent,g?(u[f.userId]=g,h["a"].db.userRepository.add(g)):u[f.userId]={userId:f.userId,username:f.userId};case 29:e.next=14;break;case 31:e.next=36;break;case 33:e.prev=33,e.t0=e["catch"](12),c.e(e.t0);case 36:return e.prev=36,c.f(),e.finish(36);case 39:return i=Object.values(u),e.abrupt("return",{msg:"",data:{messageArr:a,userArr:i}});case 41:case"end":return e.stop()}}),e,null,[[12,33,36,39]])})));return function(t,r,n){return e.apply(this,arguments)}}(),K=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n?h["a"].roomObjects[t].syncRequest({messageType:"fetchUser",content:{userId:r}},n):h["a"].roomObjects[t].syncRequest({messageType:"fetchUser",content:{userId:r}}),e.abrupt("return",new Promise((function(e,n){h["a"].roomObjects[t].deliverUser[r]=e})));case 2:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),P=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,s,o,c,d,g;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return"image"===t.messageType&&(t.name=t.content.name,r=new I.a,h["a"].roomObjects[t.groupId].uploadClients.push(r),h["a"].roomObjects[t.groupId].clients.push(r),r.seed(t.content,null,function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(r){var a,s,o,c;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,fetch(URL.createObjectURL(t.content)).then((function(e){return e.blob()})).then((function(e){n=e,h["a"].db.fileRepository.put({hash:r.infoHash,type:"blob",blob:e,time:t.time,access:t.groupId,name:t.content.name}),t.content={hash:r.infoHash,name:t.content.name,type:t.content.type,size:t.content.size}}));case 3:return t.time||(t.time=Date.now()),e.next=6,h["a"].db.groupRepository.where({groupId:t.groupId}).first();case 6:a=e.sent,t.preHash=a.lastMessage,t.hash=h["a"].web3.eth.accounts.hashMessage(a.lastMessage+t.groupId+t.content+t.time),s=h["a"].web3.eth.accounts.sign(t.hash,h["a"].user.privateKey),t.signature=s.signature,o=h["a"].roomObjects[t.groupId].room.getPeers(),delete t._id,c=new FileReader;try{n&&(c.readAsDataURL(n),c.onload=Object(u["a"])(regeneratorRuntime.mark((function e(){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.dataURL=this.result,0!=o.length&&h["a"].roomObjects[t.groupId].sendMessage(t),h["a"].db.groupMessageRepository.add(t).then((function(){f["a"].updateChain(t.groupId,t.time)})),e.next=6,h["a"].db.groupRepository.update(t.groupId,{lastMessage:t.hash}).then((function(){}));case 6:return r={userId:h["a"].user.userId,groupId:t.groupId,content:t.content,dataURL:t.dataURL,width:t.width,height:t.height,messageType:t.messageType,name:t.name,hash:t.hash},i["a"].receiveGroupMessage(r),e.abrupt("return");case 9:case"end":return e.stop()}}),e,this)}))),c.onerror=function(){})}catch(d){}case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())),"file"===t.messageType&&(t.name=t.content.name,a=new I.a,h["a"].roomObjects[t.groupId].clients.push(a),h["a"].roomObjects[t.groupId].uploadClients.push(a),a.seed(t.content,null,function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(r){var a,s,o,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,fetch(URL.createObjectURL(t.content)).then((function(e){return e.blob()})).then((function(e){n=e,h["a"].db.fileRepository.put({hash:r.infoHash,type:"blob",blob:e,time:t.time,access:t.groupId,name:t.content.name}),t.content={hash:r.infoHash,name:t.content.name,type:t.content.type,size:t.content.size}}));case 3:return t.time||(t.time=Date.now()),e.next=6,h["a"].db.groupRepository.where({groupId:t.groupId}).first();case 6:return a=e.sent,t.preHash=a.lastMessage,t.hash=h["a"].web3.eth.accounts.hashMessage(a.lastMessage+t.groupId+t.content+t.time),s=h["a"].web3.eth.accounts.sign(t.hash,h["a"].user.privateKey),t.signature=s.signature,h["a"].db.groupMessageRepository.add(t).then((function(){f["a"].updateChain(t.groupId,t.time)})),e.next=14,h["a"].db.groupRepository.update(t.groupId,{lastMessage:t.hash}).then((function(){}));case 14:return o=h["a"].roomObjects[t.groupId].room.getPeers(),delete t._id,0!=o.length&&h["a"].roomObjects[t.groupId].sendMessage(t),u={userId:h["a"].user.userId,groupId:t.groupId,content:t.content,width:t.width,height:t.height,messageType:t.messageType,name:t.name,hash:t.hash},i["a"].receiveGroupMessage(u),e.abrupt("return");case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())),t.time||(t.time=Date.now()),e.next=6,h["a"].db.groupRepository.where({groupId:t.groupId}).first();case 6:if(s=e.sent,o=t.content,s.privateKey&&(t.content=p["a"].XORencryption(t.content,s.privateKey+t.time)),t.preHash=s.lastMessage,t.hash=h["a"].web3.eth.accounts.hashMessage(s.lastMessage+t.groupId+t.content+t.time),c=h["a"].web3.eth.accounts.sign(t.hash,h["a"].user.privateKey),t.signature=c.signature,"text"!==t.messageType){e.next=24;break}return h["a"].db.groupMessageRepository.add(t).then((function(){f["a"].updateChain(t.groupId,t.time)})),e.next=17,h["a"].db.groupRepository.update(t.groupId,{lastMessage:t.hash}).then((function(){}));case 17:d=h["a"].roomObjects[t.groupId].room.getPeers(),delete t._id,0!=d.length&&h["a"].roomObjects[t.groupId].sendMessage(t),g={userId:h["a"].user.userId,groupId:t.groupId,content:o,width:t.width,height:t.height,messageType:t.messageType,hash:t.hash},i["a"].receiveGroupMessage(g);case 24:if("fetchOldMessage"==t.messageType&&h["a"].roomObjects[t.groupId].sendMessage(t),"admin"!=t.messageType){e.next=29;break}return h["a"].roomObjects[t.groupId].sendMessage(t),e.abrupt("return",t);case 29:if("user"!=t.messageType){e.next=33;break}return h["a"].roomObjects[t.groupId].sendMessage(t),e.abrupt("return",t);case 33:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),q=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,s,o,u,c;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,h["a"].db.groupRepository.where({groupId:t.groupId}).first();case 2:if(r=e.sent,"image"===t.messageType&&(n="".concat(Date.now(),"$").concat(t.userId,"$").concat(t.width,"$").concat(t.height),a=createWriteStream(join("public/static",n)),a.write(t.content),t.content=n),t.time=Date.now(),t.preHash=r.lastMessage,t.hash=h["a"].web3.eth.accounts.hashMessage(r.lastMessage+t.groupId+t.content+t.time),s=h["a"].web3.eth.accounts.sign(t.hash,h["a"].user.privateKey),t.signature=s.signature,"text"!==t.messageType){e.next=23;break}return h["a"].db.groupMessageRepository.add(t),e.next=16,h["a"].db.groupRepository.update(t.groupId,{lastMessage:t.hash});case 16:o=h["a"].roomObjects[t.groupId].room.getPeers(),delete t._id,0!=o.length&&h["a"].roomObjects[t.groupId].sendMessage(t,h["a"].roomObjects[t.groupId].userIdsToIds[t.to]),u={userId:h["a"].user.userId,groupId:t.groupId,content:t.content,width:t.width,height:t.height,messageType:t.messageType,hash:t.hash},i["a"].receiveGroupMessage(u);case 23:"fetchOldMessage"==t.messageType&&(c=t.to,delete t.to,h["a"].roomObjects[t.groupId].sendMessage(t,c));case 24:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),H=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),$=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,o,u,i,c,d,p,g,b,l,v,w,k,x,R,O,j,T,S,M,G,A,B,C,K,P,q,$,z,E,L;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:r={appId:"ichat"},n=Object(y["a"])(r,t),n.onPeerJoin((function(e){})),a=n.makeAction("message"),o=Object(s["a"])(a,2),u=o[0],i=o[1],i((function(e,r){N(t,e,h["a"].roomObjects[t].idsToUserIds[r])})),c=n.makeAction("private"),d=Object(s["a"])(c,2),p=d[0],g=d[1],g((function(e,r){N(t,e,h["a"].roomObjects[t].idsToUserIds[r])})),b=n.makeAction("sync"),l=Object(s["a"])(b,2),v=l[0],w=l[1],w((function(e,r,n){-1==f["a"].syncTasks[t].ban.indexOf(r)&&_(t,e,r,n)})),k=n.makeAction("requireOld"),x=Object(s["a"])(k,2),R=x[0],O=x[1],O((function(e,r){S(t,e,h["a"].roomObjects[t].idsToUserIds[r])})),j=n.makeAction("oldMessage"),T=Object(s["a"])(j,2),S=T[0],M=T[1],M((function(e,r){H(t,e,t,h["a"].roomObjects[t].idsToUserIds[r])})),G=n.makeAction("file"),A=Object(s["a"])(G,3),B=A[0],C=A[1],A[2],C((function(e,r,n){U(t,e,r,n)})),K={},P={},K[y["b"]]=h["a"].user.username,P[y["b"]]=h["a"].user.userId,q=new I.a,h["a"].roomObjects[t]={room:n,selfId:y["b"],sendMessage:u,sendPrivateMessage:p,sendFile:B,syncRequest:v,deliverUser:{},sendOldMessage:S,fetchOldMessage:R,idsToNames:K,idsToUserIds:P,userIdsToIds:{},offline:[],groupId:t,uploadClient:q,deliverFile:{},clients:[q],uploadClients:[q]},$=n.makeAction("name"),z=Object(s["a"])($,2),E=z[0],L=z[1],E(h["a"].user.username+":"+h["a"].user.userId),L((function(e,r){h["a"].roomObjects[t].idsToNames[r]=e.split(":")[0];var n=e.split(":")[1];h["a"].roomObjects[t].idsToUserIds[r]=n,h["a"].roomObjects[t].userIdsToIds[n]=r,h["a"].db.userRepository.add({userId:n,username:e.split(":")[0]}),D()})),h["a"].db.groupBlockRepository.where("[groupId+time]").between([t,m["a"].minKey],[t,m["a"].maxKey]).reverse().first((function(e){var r=Date.now();e&&(e.time,h["a"].roomObjects[t].offline=[r-r%1e6-1,r])})),f["a"].syncTasks[t]={deliverRecentBlocks:{},deliverAllBlocks:{},deliverAncestorNeighbors:{},deliverBlock:{},forks:{},limits:{},ban:[]},f["a"].updateChain(t),n.onPeerJoin((function(e){E(h["a"].user.username+":"+h["a"].user.userId,e),f["a"].sync(t,e),F(t,e)}));case 30:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),F=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(t,r){var n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return h["a"].iterations++,n=h["a"].roomObjects[t],n.offline&&q({userId:h["a"].user.userId,groupId:n.groupId,content:{key:"time",time:[n.offline[0],Date.now()+2e3]},messageType:"fetchOldMessage",to:r}),e.next=7,d["a"].acquireMessage(n.groupId.trim(),n.groupId.trim(),1);case 7:a=e.sent,a=JSON.parse(a),N(n.groupId,a,a.userId),h["a"].iterations>2&&(clearInterval(h["a"].interval),h["a"].iterations=0);case 13:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),D=function(){var e=Object(u["a"])(regeneratorRuntime.mark((function e(){var t,r,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:for(r in t={},h["a"].roomObjects)for(n in h["a"].roomObjects[r].idsToUserIds)t[r]||(t[r]={}),t[r][h["a"].roomObjects[r].idsToUserIds[n]]={userId:h["a"].roomObjects[r].idsToUserIds[n],username:h["a"].roomObjects[r].idsToNames[n]};i["a"].activeGroupUser({msg:"activeGroupUser",data:t});case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();t["default"]=(n={getMyGroup:x,getGroupInfo:O,searchGroup:j,addNewGroupUser:T,createGroup:M,getRecentGroup:R,getAllGroup:S},Object(a["a"])(n,"createGroup",M),Object(a["a"])(n,"joinGroup",A),Object(a["a"])(n,"joinGroupSocket",G),Object(a["a"])(n,"roomInit",$),Object(a["a"])(n,"receiveGroupMessage",N),Object(a["a"])(n,"sendGroupMessage",P),Object(a["a"])(n,"getGroupMessages",C),Object(a["a"])(n,"fetchUser",K),Object(a["a"])(n,"fetchFile",B),n)}.call(this,r("b639").Buffer)},"3fff":function(e,t,r){"use strict";r.d(t,"b",(function(){return n})),r.d(t,"a",(function(){return a}));var n="阿童木聊天室",a="https://images.weserv.nl/?url=https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/453b8ebcdefa46a69c620da13f346ce2~tplv-k3u1fbpfcp-zoom-1.image?imageView2/2/w/800/q/85"},4:function(e,t){},40:function(e,t){},41:function(e,t){},42:function(e,t){},43:function(e,t){},44:function(e,t){},45:function(e,t){},46:function(e,t){},47:function(e,t){},48:function(e,t){},"48b8":function(e,t,r){"use strict";r.d(t,"g",(function(){return s})),r.d(t,"b",(function(){return o})),r.d(t,"e",(function(){return u})),r.d(t,"c",(function(){return i})),r.d(t,"a",(function(){return c})),r.d(t,"d",(function(){return d})),r.d(t,"f",(function(){return p}));r("c975"),r("4d63"),r("ac1f"),r("25f0");var n=r("8bbf"),a=r.n(n);r("99e5");function s(e){var t=e.code,r=e.msg,n=e.data;if(!t)return r&&a.a.prototype.$message.success(r),n;a.a.prototype.$message.error(r)}function o(e,t){return t.indexOf(e)>=0}function u(e){return e}function i(e){var t=new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/);return t.test(e)}function c(e){var t=a.a.prototype.$moment;return t().add(-1,"days").startOf("day")>e?t(e).format("M/D HH:mm"):t().startOf("day")>e?"昨天 "+t(e).format("HH:mm"):(new Date).valueOf()>e+3e5?t(e).format("HH:mm"):t(e).format("HH:mm:ss")}function d(e){var t=/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/;return 0===e.length?(a.a.prototype.$message.error("请输入名字"),!1):t.test(e)?!(e.length>9)||(a.a.prototype.$message.error("名字太长"),!1):(a.a.prototype.$message.error("名字只含有汉字、字母、数字和下划线 不能以下划线开头和结尾"),!1)}function p(e){var t=/^[0-9A-Z_a-z]+$/gi;return 0===e.length?(a.a.prototype.$message.error("请输入密码"),!1):t.test(e)?!(e.length>9)||(a.a.prototype.$message.error("密码太长"),!1):(a.a.prototype.$message.error("密码只含有字母、数字和下划线"),!1)}},49:function(e,t){},5:function(e,t){},50:function(e,t){},51:function(e,t){},52:function(e,t){},53:function(e,t){},54:function(e,t){},55:function(e,t){},56:function(e,t){},57:function(e,t){},58:function(e,t){},5880:function(e,t){e.exports=Vuex},59:function(e,t){},"5ab6":function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return a}));var n={groupId:"o",groupName:"服务号"},a=["你好。欢迎使用去中心化聊天网页。本网页采用vuex，web3，webrtc等技术开发，所有数据保存在您的设备上，或加密保存在您好友的设备上。","添加好友：点击左上角的加号，点击搜索用户，输入好友分享给您的链接\n。\n\r个人设置：点击左上角头像。\n选择背景：点击左侧“衣服”符号。\n推出登陆：点击左下角“关机”符号。\n","技术细节：\n\r当您注册时，网页的js代码根据您输入的账号密码及当前时间，生成一个以太坊账号。该账号具有一个私钥。它是您的公开账号。\n添加好友：若A账号向B账号发送好友申请，它会"]},"5b74":function(e,t,r){"use strict";r("7db0"),r("b0c0"),r("a9e3"),r("d3b7"),r("4d63"),r("ac1f"),r("25f0");var n=r("53ca"),a=r("b85c"),s=r("5530"),o=(r("96cf"),r("1da1")),u=r("3f4c"),i=r("15a6"),c={message:"",messageType:"text",time:Date.now()},d=function(){var e=Object(o["a"])(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,NEWS.insertMany(t);case 2:return r=e.sent,e.abrupt("return",r[0]);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),p=function(){var e=Object(o["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,o,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.query,a=n.roomid,s=n.page,o=n.pageSize,e.prev=1,e.next=4,NEWS.find({roomid:a}).sort({_id:-1}).skip(Number(s*o)).limit(Number(o));case 4:return u=e.sent,e.abrupt("return",r.json({status:2e3,data:u,msg:"获取成功"}));case 8:e.prev=8,e.t0=e["catch"](1),r.json({status:2003,data:e.t0,msg:"服务端错误，请稍后重试！"});case 11:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}(),f=function(){var e=Object(o["a"])(regeneratorRuntime.mark((function e(t,r){var n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body.roomid,e.next=3,NEWS.findOne({roomid:n}).sort({_id:-1});case 3:return a=e.sent,e.abrupt("return",r.json({status:2e3,data:a||Object(s["a"])({roomid:n},c),msg:"获取成功"}));case 5:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),g=function(){var e=Object(o["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,o;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.roomid,s=n.userId,e.next=3,NEWS.updateMany({roomid:a},{$addToSet:{isReadUser:s}});case 3:return o=e.sent,e.abrupt("return",r.json({status:2e3,data:o,msg:"success"}));case 5:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),h=function(){var e=Object(o["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,o,u,i,c,d,p,f,g,h,m,b,l;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.roomid,o=n.type,u=n.query,i=n.date,c=n.page,d=n.pageSize,p=new RegExp(u),f={roomid:a,message:{$regex:p}},"all"!==o&&(f["messageType"]=o,delete f["message"]),i&&(g=todayAndTomorrow(i),h=g.today,m=g.tomorrow,f["time"]={$gte:h,$lt:m}),e.next=8,NEWS.find(Object(s["a"])({},f)).skip(Number(c*d)).limit(Number(d));case 8:return b=e.sent,e.next=11,NEWS.find(Object(s["a"])({},f)).count();case 11:return l=e.sent,e.abrupt("return",r.json({status:2e3,data:{data:b,total:l},msg:"success"}));case 13:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),m=function(e){var t=[];if(e.groupId){var r,n=Object(a["a"])(i["a"].roomObjects[e.groupId].clients);try{for(n.s();!(r=n.n()).done;){var s,o=r.value,u=Object(a["a"])(o.torrents);try{for(u.s();!(s=u.n()).done;){var c=s.value;c.infoHash==e.content.hash&&t.push(c)}}catch(b){u.e(b)}finally{u.f()}}}catch(b){n.e(b)}finally{n.f()}if(t.length>0){var d,p=t[0],f=t[0].timeRemaining,g=Object(a["a"])(t);try{for(g.s();!(d=g.n()).done;){var h=d.value;h.timeRemaining<f&&(p=h)}}catch(b){g.e(b)}finally{g.f()}var m=p;return{numPeers:m.numPeers,progress:m.progress,downloaded:m.downloaded,length:m.length,done:m.done,timeRemaining:m.timeRemaining,downloadSpeed:m.downloadSpeed,uploadSpeed:m.uploadSpeed}}}},b={},l=function(){var e=Object(o["a"])(regeneratorRuntime.mark((function e(t){var r,s,c,d,p,f,g,h,m,l,y,v,w,I,k,x,R,O,j,T;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(s=[],!t.groupId){e.next=39;break}c=Object(a["a"])(i["a"].roomObjects[t.groupId].clients),e.prev=4,c.s();case 6:if((d=c.n()).done){e.next=31;break}p=d.value,f=Object(a["a"])(p.torrents),e.prev=9,f.s();case 11:if((g=f.n()).done){e.next=21;break}if(h=g.value,h.infoHash!=t.content.hash){e.next=19;break}if(1!=h.progress&&!h.done&&h.length!=h.downloaded){e.next=18;break}return e.abrupt("return",h.files[0]);case 18:s.push(h);case 19:e.next=11;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e["catch"](9),f.e(e.t0);case 26:return e.prev=26,f.f(),e.finish(26);case 29:e.next=6;break;case 31:e.next=36;break;case 33:e.prev=33,e.t1=e["catch"](4),c.e(e.t1);case 36:return e.prev=36,c.f(),e.finish(36);case 39:return e.next=41,i["a"].db.fileRepository.where({hash:t.content.hash}).first();case 41:if(r=e.sent,!r){e.next=69;break}if("blob"!=r.type){e.next=67;break}if(m=new File([r.blob],t.content.name,{type:t.content.type}),!t.groupId){e.next=67;break}l=Object(a["a"])(i["a"].roomObjects[t.groupId].uploadClient.torrents),e.prev=49,v=function(){var e=y.value;if(e.infoHash==t.content.hash)return{v:new Promise((function(t,r){t(e.files[0])}))}},l.s();case 52:if((y=l.n()).done){e.next=58;break}if(w=v(),"object"!==Object(n["a"])(w)){e.next=56;break}return e.abrupt("return",w.v);case 56:e.next=52;break;case 58:e.next=63;break;case 60:e.prev=60,e.t2=e["catch"](49),l.e(e.t2);case 63:return e.prev=63,l.f(),e.finish(63);case 66:return e.abrupt("return",new Promise((function(e,r){i["a"].roomObjects[t.groupId].uploadClient.seed(m,null,function(){var t=Object(o["a"])(regeneratorRuntime.mark((function t(r){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e(r.files[0]);case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())})));case 67:e.next=93;break;case 69:if(!(s.length>0)){e.next=77;break}I=s[0],k=s[0].timeRemaining,x=Object(a["a"])(s);try{for(x.s();!(R=x.n()).done;)O=R.value,O.timeRemaining<k&&(I=O)}catch(S){x.e(S)}finally{x.f()}if(!(I.downloaded>0)){e.next=77;break}return e.abrupt("return",I.files[0]);case 77:if(null==b[t.content.hash]){e.next=83;break}return b[t.content.hash].status,e.next=82,b[t.content.hash].filePromise;case 82:return e.abrupt("return",e.sent);case 83:if(!t.groupId){e.next=93;break}return j=u["default"].fetchFile(t),b[t.content.hash]={status:"processing",filePromise:j},e.next=88,j;case 88:if(T=e.sent,!T){e.next=93;break}return T.getBlob((function(e,r){i["a"].db.fileRepository.put({hash:t.content.hash,type:"blob",blob:r,time:t.time,access:t.groupId,name:t.content.name}).then((function(){}))})),e.abrupt("return",T);case 93:case"end":return e.stop()}}),e,null,[[4,33,36,39],[9,23,26,29],[49,60,63,66]])})));return function(t){return e.apply(this,arguments)}}();t["a"]={insertNewNews:d,getRecentNews:p,getLastNews:f,userIsReadMsg:g,getHistoryMsg:h,fetchFile:l,fetchProgress:m}},"5c0b":function(e,t,r){"use strict";var n=r("9c0c"),a=r.n(n);a.a},6:function(e,t){},60:function(e,t){},61:function(e,t){},62:function(e,t){},63:function(e,t){},6389:function(e,t){e.exports=VueRouter},64:function(e,t){},65:function(e,t){},66:function(e,t){},67:function(e,t){},68:function(e,t){},69:function(e,t){},7:function(e,t){},70:function(e,t){},71:function(e,t){},72:function(e,t){},8:function(e,t){},"85e5":function(e,t,r){"use strict";r("c975"),r("d3b7"),r("ac1f"),r("25f0"),r("5319"),r("b85c");var n=r("15a6"),a=(r("1fb5"),{_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,r,n,s,o,u,i,c="",d=0;e=a._utf8_encode(e);while(d<e.length)t=e.charCodeAt(d++),r=e.charCodeAt(d++),n=e.charCodeAt(d++),s=t>>2,o=(3&t)<<4|r>>4,u=(15&r)<<2|n>>6,i=63&n,isNaN(r)?u=i=64:isNaN(n)&&(i=64),c=c+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(i);return c},decode:function(e){var t,r,n,s,o,u,i,c="",d=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(d<e.length)s=this._keyStr.indexOf(e.charAt(d++)),o=this._keyStr.indexOf(e.charAt(d++)),u=this._keyStr.indexOf(e.charAt(d++)),i=this._keyStr.indexOf(e.charAt(d++)),t=s<<2|o>>4,r=(15&o)<<4|u>>2,n=(3&u)<<6|i,c+=String.fromCharCode(t),64!=u&&(c+=String.fromCharCode(r)),64!=i&&(c+=String.fromCharCode(n));return c=a._utf8_decode(c),c},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",r=0;r<e.length;r++){var n=e.charCodeAt(r);n<128?t+=String.fromCharCode(n):n>127&&n<2048?(t+=String.fromCharCode(n>>6|192),t+=String.fromCharCode(63&n|128)):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128),t+=String.fromCharCode(63&n|128))}return t},_utf8_decode:function(e){var t="",r=0,n=0,a=0,s=0;while(r<e.length)n=e.charCodeAt(r),n<128?(t+=String.fromCharCode(n),r++):n>191&&n<224?(s=e.charCodeAt(r+1),t+=String.fromCharCode((31&n)<<6|63&s),r+=2):(s=e.charCodeAt(r+1),a=e.charCodeAt(r+2),t+=String.fromCharCode((15&n)<<12|(63&s)<<6|63&a),r+=3);return t}}),s=function(e){for(var t="",r=2;r<e.length-3;r+=4){var n="0x"+e[r]+e[r+1]+e[r+2]+e[r+3];t+=String.fromCharCode(parseInt(n,16))}return t},o=function(e){return s(n["a"].web3.eth.accounts.hashMessage(e))},u=function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:o;if("string"!==typeof e)return e;for(var s=n(t),u="",i=0;i<parseInt(e.length/s.length)+1;i++){s=n(t+i);for(var c=0;c<s.length;c++){if(i*s.length+c>=e.length)break;u+=String.fromCharCode(e.charCodeAt(i*s.length+c)^s.charCodeAt(c))}}return r?a.encode(u):u},i=function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:o;if("string"!==typeof e)return e;for(var s=r?a.decode(e):e,u=n(t),i="",c=0;c<parseInt(s.length/u.length)+1;c++){u=n(t+c);for(var d=0;d<u.length;d++){if(c*u.length+d>=s.length)break;i+=String.fromCharCode(s.charCodeAt(c*u.length+d)^u.charCodeAt(d))}}return i},c=function(e,t){e=parseInt(e).toString(2).toString(),t=parseInt(t).toString(2).toString();var r="";if(e.length<t.length)for(var n=0;n<t.length-e.length;n++)e="0"+t;if(t.length<e.length)for(var a=0;a<e.length-t.length;a++)t="0"+e;for(var s=0;s<e.length;s++)e[s]===t[s]?r+="0":r+="1";return r},d=function(e,t){if(e.length<t.length)for(var r=0;r<t.length-e.length;r++)e="0"+t;if(t.length<e.length)for(var n=0;n<e.length-t.length;n++)t="0"+e;for(var a=!0,s=0;s<e.length;s++)if(e[s]!=t[s]){"1"===e[s]&"0"===t[s]&&(a=!1);break}return a};t["a"]={leq:d,XOR:c,XORencryption:u,decodeXOR:i}},"8bbf":function(e,t){e.exports=Vue},9:function(e,t){},"9c0c":function(e,t,r){},a090:function(e,t,r){"use strict";r.r(t),r.d(t,"getAllData",(function(){return m}));r("99af"),r("4de4"),r("d81d"),r("d3b7"),r("07ac"),r("3ca3"),r("ddb0");var n=r("2909"),a=r("b85c"),s=(r("96cf"),r("1da1")),o=r("302f"),u=r("5ab6"),i=(r("0613"),r("739d"),r("a002"),r("3f4c"),r("e013"),r("21e1")),c=r("4dec"),d=r("15a6"),p=new c["a"](d["a"].user.userId);p.version(1).stores({groupUserRepository:"++_id, groupId, userId",groupMessageRepository:"++_id, userId, groupId, content, messageType, time",groupRepository:"groupId, userId, groupName, notice,createTime"});var f=r("85e5"),g=r("99e5"),h=r.n(g),m=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,u,p,g,h,m,b,y,v,w,I,k,x,R,O;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return l(t.userId),r=d["a"].db,u=[],p=[],g={},h=[],e.next=9,r.groupUserRepository.where({userId:t.userId}).toArray();case 9:return m=e.sent,m.map((function(e){return e.groupId})),e.next=13,r.friendRepository.where({userId:t.userId}).toArray();case 13:return b=e.sent,y=m.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",r.groupRepository.where({groupId:t.groupId}).first());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),v=m.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var n,s,o,u,i,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=[],e.next=3,r.groupMessageRepository.orderBy("time");case 3:return e.next=6,r.groupMessageRepository.where("[groupId+time]").between([t.groupId,c["a"].minKey],[t.groupId,c["a"].maxKey]).reverse().limit(30).toArray();case 6:return n=e.sent,n=n.reverse(),e.next=11,d["a"].db.groupRepository.where({groupId:t.groupId}).first();case 11:s=e.sent,n.map((function(e){var t=e;return s.privateKey&&(t.content=f["a"].decodeXOR(t.content,s.privateKey+t.time)),t})),o=Object(a["a"])(n),e.prev=14,o.s();case 16:if((u=o.n()).done){e.next=25;break}if(i=u.value,g[i.userId]){e.next=23;break}return e.next=21,r.userRepository.where({userId:i.userId}).first();case 21:p=e.sent,g[i.userId]=p||{userId:i.userId,username:i.userId};case 23:e.next=16;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e["catch"](14),o.e(e.t0);case 30:return e.prev=30,o.f(),e.finish(30);case 33:return e.abrupt("return",n);case 34:case"end":return e.stop()}}),e,null,[[14,27,30,33]])})));return function(t){return e.apply(this,arguments)}}()),w=b.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,r.userRepository.where({userId:t.friendId}).first();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),I=b.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,friendMessageRepository.where("[userId+friendId+time]").between([t.userId,t.friendId,c["a"].minKey],[t.userId,t.friendId,c["a"].maxKey]).or("[userId+friendId+time]").between([t.friendId,t.userId,c["a"].minKey],[t.friendId,t.userId,c["a"].maxKey]).reverse().limit(30).sortBy("time").toArray();case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=21,Promise.all(y);case 21:return k=e.sent,e.next=24,Promise.all(v);case 24:return x=e.sent,k.map((function(e,t){x[t]&&x[t].length&&(e.messages=x[t])})),u=k,e.next=30,Promise.all(w);case 30:return R=e.sent,e.next=33,Promise.all(I);case 33:O=e.sent,R.map((function(e,t){O[t]&&O[t].length&&(e.messages=O[t])})),p=R,h=[].concat(Object(n["a"])(Object.values(g)),Object(n["a"])(p)),h=h.filter((function(e){return e})),i["a"].refreshChatData({code:o["a"].OK,msg:"获取聊天数据成功",data:{groupData:u,friendData:p,userData:h}});case 40:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),b=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,d["a"].db.userRepository.add({userId:d["a"].user.userId,username:d["a"].user.username});case 2:return e.next=4,d["a"].db.groupRepository.add({groupId:u["a"].groupId,userId:t,groupName:"服务群",createTime:(new Date).valueOf(),lastMessage:u["a"].groupId});case 4:return e.next=6,d["a"].db.groupUserRepository.add({groupId:u["a"].groupId,userId:t});case 6:r=0;case 8:if(!(r<u["b"].length)){e.next=14;break}return e.next=11,d["a"].db.groupMessageRepository.add({userId:"0",groupId:u["a"].groupId,content:u["b"][r],width:void 0,height:void 0,messageType:"text",time:0});case 11:r++,e.next=8;break;case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),l=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=new c["a"](t),d["a"].db=r,r.version(1).stores({groupUserRepository:"++_id, groupId, userId",groupMessageRepository:"++_id, userId, groupId, content, messageType, time, preHash, &hash, signature, [groupId+time]",groupRepository:"&groupId, userId, groupName, createTime, lastMessage",friendRepository:"++_id, friendId, &userId",userRepository:"&userId, username",friendMessageRepository:"++_id, friendId, userId, content, time, [userId+friendId+time]",groupBlockRepository:" [groupId+number], &hash, groupId, messageRoot, time, preHash,  number, [groupId+time]",fileRepository:"hash, time, access  ",roomRepository:"id, privateKey, publicKey, ring, nodeId"}),n=new h.a(new h.a.providers.WebsocketProvider("wss://rinkeby.infura.io/ws/v3/a898a2d231e647c7928dc457c6d441c8")),d["a"].web3=n,e.next=8,d["a"].db.userRepository.where({userId:d["a"].user.userId});case 8:a=e.sent,d["a"].user.avatar=a.avatar;case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();t["default"]={serviceInit:b,dbInit:l,dataInit:y,getAllData:m}},c32d:function(e,t){e.exports=moment},cd49:function(e,t,r){"use strict";r.r(t);r("e260"),r("e6cf"),r("cca6"),r("a79d");var n=r("8bbf"),a=r.n(n),s=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{attrs:{id:"app"}},[r("router-view"),e.background?r("img",{staticClass:"background",attrs:{src:e.background,alt:""}}):e._e()],1)},o=[],u=(r("ac1f"),r("466d"),r("498a"),r("d4ec")),i=r("bee2"),c=r("262e"),d=r("2caf"),p=r("9ab4"),f=r("60a3"),g=r("4bb5"),h=r("3fff"),m=Object(g["a"])("app"),b=function(e){Object(c["a"])(r,e);var t=Object(d["a"])(r);function r(){return Object(u["a"])(this,r),t.apply(this,arguments)}return Object(i["a"])(r,[{key:"mounted",value:function(){this.setMobile(this.isMobile()),this.background&&this.background.trim().length||this.set_background(h["a"])}},{key:"isMobile",value:function(){var e=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);return e&&e.length}}]),r}(f["c"]);Object(p["a"])([m.Getter("user")],b.prototype,"user",void 0),Object(p["a"])([m.Getter("background")],b.prototype,"background",void 0),Object(p["a"])([m.Mutation("set_mobile")],b.prototype,"setMobile",void 0),Object(p["a"])([m.Mutation("set_background")],b.prototype,"set_background",void 0),b=Object(p["a"])([f["a"]],b);var l=b,y=l,v=(r("5c0b"),r("2877")),w=Object(v["a"])(y,s,o,!1,null,null,null),I=w.exports,k=(r("d3b7"),r("6389")),x=r.n(k);a.a.use(x.a);var R=[{path:"/",name:"Chat",component:function(){return r.e("chunk-93ce8030").then(r.bind(null,"edc5"))}}],O=new x.a({mode:"history",base:"/",routes:R}),j=O,T=r("0613"),S=r("6944"),M=r.n(S),G=r("4eb5"),A=r.n(G),U=(r("3aed"),r("27fd")),_=r("5efb"),N=r("b558"),B=r("ed3b"),C=r("3af3"),K=r("bb76"),P=r("0c63"),q=r("ccb9"),H=r("681b"),$=r("a600"),F=r("55f1"),D=r("cdeb"),z=r("9839"),E=r("39ab"),L=r("f933"),J=r("9571"),W=r("768f"),X=r("a071"),V=r("f64c");a.a.use(U["a"]),a.a.use(_["a"]),a.a.use(N["a"]),a.a.use(B["a"]),a.a.use(C["a"]),a.a.use(K["a"]),a.a.use(P["a"]),a.a.use(q["a"]),a.a.use(H["a"]),a.a.use($["a"]),a.a.use(F["a"]),a.a.use(D["a"]),a.a.use(z["a"]),a.a.use(E["a"]),a.a.use(L["a"]),a.a.use(J["a"]),a.a.use(W["a"]),a.a.use(X["a"]),a.a.prototype.$message=V["a"];var Z=r("c32d"),Q=r.n(Z);r("0808");a.a.use(A.a),a.a.config.productionTip=!1,a.a.prototype.$moment=Q.a,a.a.use(M.a,{defaultOptions:{navbar:!1,title:!1,toolbar:{zoomIn:1,zoomOut:1,oneToOne:4,reset:4,prev:0,next:0,rotateLeft:4,rotateRight:4,flipHorizontal:4,flipVertical:4}}}),new a.a({router:j,store:T["a"],render:function(e){return e(I)}}).$mount("#app")},cebe:function(e,t){e.exports=axios},cfbb:function(e,t,r){"use strict";r("99af"),r("96cf");var n=r("1da1"),a=r("3f4c"),s=r("0613"),o=r("302f");t["a"]={getMyGroup:function(e){var t=e.userName;return request.get("".concat(API,"/group/getmygroup?userName=").concat(t))},getGroupInfo:function(e){var t=e.id;return request.get("".concat(API,"/group/groupinfo?id=").concat(t))},preFetchGroup:function(e){var t=e.type,r=e.q,n=e.page,a=e.pageSize;return request.get("".concat(API,"/group/prefetchgroup?type=").concat(t,"&q=").concat(r,"&page=").concat(n,"&pageSize=").concat(a))},createGroup:function(e){return request.post("".concat(API,"/group/create"),e)},getRecentGroupConversation:function(e){return request.post("".concat(API,"/group/recent"),e)},clientJoinGroup:function(e){s["a"].dispatch("chat/joinGroup",e)},serverJoinGroup:function(e){a["default"].joinGroup(e)},addGroup:function(e){a["default"].createGroup(e)},clientAddgroup:function(e){s["a"].dispatch("chat/addGroup",e)},joinGroupSocket:function(e){a["default"].joinGroupSocket(e)},clientJoinGroupSocket:function(e){s["a"].dispatch("chat/joinGroupSocket",e)},activeGroupUser:function(e){s["a"].dispatch("chat/activeGroupUser",e)},getRecentGroupNews:function(e){var t=e.roomid,r=e.page,n=e.pageSize;return request.get("".concat(API,"/groupnews/recentnews?roomid=").concat(t,"&page=").concat(r,"&pageSize=").concat(n))},getGroupHistoryMsg:function(e){return request.post("".concat(API,"/groupnews/historymsg"),e)},getGroupLastNews:function(e){return request.post("".concat(API,"/groupnews/lastnews"),e)},receiveGroupMessage:function(e){s["a"].dispatch("chat/groupMessage",{code:o["a"].OK,msg:"",data:e})},getGroupMessages:function(e){return Object(n["a"])(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,a["default"].getGroupMessages(e.groupId,e.current,e.pageSize);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)})))()},sendGroupMessage:function(e){a["default"].sendGroupMessage(e)}}},d54a:function(e,t,r){"use strict";r.r(t);r("7db0"),r("c740"),r("caad"),r("d81d"),r("a434"),r("b0c0"),r("a9e3"),r("b64b"),r("d3b7"),r("07ac"),r("4d63"),r("ac1f"),r("25f0"),r("2532");var n=r("ade3"),a=(r("96cf"),r("1da1")),s=r("302f"),o=r("5ab6"),u=r("15a6"),i=r("0613"),c=r("a090"),d=r("a002"),p=r.n(d),f=r("99e5"),g=r.n(f),h=(r("48b8"),r("3f4c")),m=function(e,t){var r=cvCode(),n=r.code,a=r.timestamp;return verificationCode=n,t.json({status:2e3,data:verificationCode,timestamp:a,msg:"code success"})},b=function(){for(var e=0;e<o["b"].length;e++)i["a"].dispatch("chat/groupMessage",{code:s["a"].OK,msg:"",data:{userId:"0",groupId:o["a"].groupId,content:o["b"][e],width:void 0,height:void 0,messageType:"text"}})},l=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,s,o,i,c,d,f;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=[t.username,t.password],n=r[0],a=r[1],Date.now(),o=JSON.parse(localStorage.getItem(n)),e.t0=JSON,e.next=6,p.a.getItem(n);case 6:e.t1=e.sent,o=e.t0.parse.call(e.t0,e.t1),c=new g.a(new g.a.providers.WebsocketProvider("wss://rinkeby.infura.io/ws/v3/a898a2d231e647c7928dc457c6d441c8")),e.prev=9,i=c.eth.accounts.decrypt(o.secPrivateKey,a),s=i.privateKey,e.next=18;break;case 14:return e.prev=14,e.t2=e["catch"](9),e.abrupt("return",{code:1,msg:"密码错误",data:""});case 18:return d={status:0,pass:a,name:i,_id:0},d._id,0,f=JSON.parse(localStorage.getItem(n)),""==f.avatar&&(f.avatar="https://github.com/forthefreeinternet/ichat/blob/master/src/assets/wallpaper.png"),u["a"].user={username:o.accountName,userId:o.accountAddress,password:a,avatar:f.avatar,role:"user",tag:"",privateKey:s},e.abrupt("return",{msg:"登录成功",data:{user:{username:o.accountName,userId:o.accountAddress,password:a,avatar:f.avatar,role:"user",tag:""},token:"0"}});case 29:case"end":return e.stop()}}),e,null,[[9,14]])})));return function(t){return e.apply(this,arguments)}}(),y=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,o,i,d,f,h,m,b,l,y,v,w;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=[t.username,t.password,t.password,t.cvCode,t.avatar],a=n[0],o=n[1],i=n[2],n[3],n[4],o===i){e.next=4;break}return e.abrupt("return",{code:s["a"].FAIL,msg:"注册校验不通过！",data:""});case 4:if(null==localStorage.getItem(a)){e.next=6;break}return e.abrupt("return",{code:s["a"].FAIL,msg:"用户已被注册,请换个用户名重试",data:""});case 6:return e.next=8,p.a.getItem(a);case 8:if(e.t0=e.sent,null==e.t0){e.next=11;break}return e.abrupt("return",{code:s["a"].FAIL,msg:"用户已被注册,请换个用户名重试",data:""});case 11:for(d=(new Date).getTime(),f=a+o+d,h=f.length;h<32;h++)f+="0";return m=new g.a(new g.a.providers.HttpProvider("http://localhost:8545")),b=m.eth.accounts.create([f]),f=m.eth.accounts.encrypt(b.privateKey,f),l=m.eth.accounts.create([f]),y=b.address,v=m.eth.accounts.encrypt(b.privateKey,o),w={accountName:a,accountAddress:y,secPrivateKey:v,contactList:{},role:"user",publicId:l.address,group:[{groupId:"0"}],avatar:"https://github.com/forthefreeinternet/ichat/blob/master/src/assets/wallpaper.png"},u["a"].user={username:a,userId:y,password:o,privateKey:b.privateKey,avatar:"https://github.com/forthefreeinternet/ichat/blob/master/src/assets/wallpaper.png",role:"user",tag:""},localStorage.setItem(a,JSON.stringify(w)),e.next=26,p.a.setItem(a,JSON.stringify(w));case 26:return e.next=28,c["default"].dbInit(y);case 28:return e.next=30,c["default"].serviceInit(y);case 30:return e.abrupt("return",{msg:"注册成功",data:{user:{userId:y,username:a,password:o,avatar:"https://github.com/forthefreeinternet/ichat/blob/master/src/assets/wallpaper.png",role:"user",tag:"",createTime:d,publicId:l.address},token:"0"}});case 31:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),v=function(e){if(window.FileReader)var t=new FileReader;else alert("当前浏览器不支持!");return new Promise((function(r,n){try{e?(t.readAsDataURL(e),t.onload=function(){u["a"].db.userRepository.where({userId:u["a"].user.userId}).modify({avatar:this.result});var e=JSON.parse(localStorage.getItem(u["a"].user.username));for(var t in e.avatar=this.result,localStorage.setItem(u["a"].user.username,JSON.stringify(e)),u["a"].user.avatar=this.result,u["a"].roomObjects){var n={userId:u["a"].user.userId,groupId:t,messageType:"user",content:{username:u["a"].user.username,userId:u["a"].user.userId,avatar:u["a"].user.avatar}};h["default"].sendGroupMessage(n)}r(u["a"].user)},t.onerror=function(){n("load file error")}):n("file not found")}catch(a){n("file not found")}}))},w=function(e,t){var r=e.query.id;USER.findById({_id:r}).then((function(e){return e?t.json({status:2e3,data:e,msg:"获取用户详情成功！"}):t.json({status:2001,data:"",msg:"没有获取到用户数据！"})})).catch((function(e){t.json({status:2003,data:"",msg:"服务端错误，请稍后重试！"})}))},I=function(e,t){var r=e.query,a=r.type,s=r.q,o=r.page,u=r.pageSize,i=new RegExp(s);USER.find(Object(n["a"])({},a,{$regex:i})).limit(Number(u)).skip(Number(o)*Number(u)).then((function(e){return t.json({status:2e3,data:e,msg:"获取成功！"})})).catch((function(e){return t.json({status:2003,data:e,msg:"服务器错误，请稍后重试！"})}))},k=function(e,t){USER.find().then((function(e){return t.json({status:2e3,data:e,msg:"获取用户成功"})})).catch((function(e){return t.json({status:2003,data:e,msg:"服务器错误，请稍后重试！"})}))},x=function(e,t){var r=e.query,n=r.gt,a=r.lt,s=new Date(n),o=new Date(a);USER.find({signUpTime:{$lte:o,$gte:s}}).sort({signUpTime:-1}).then((function(e){return t.json({status:2e3,data:e,msg:"成功"})}))},R=function(e,t){var r=e.body,n=r.id,a=r.state;USER.findByIdAndUpdate({_id:n},{status:a}).then((function(e){t.json({status:2e3,data:e,msg:"success"})})).catch((function(e){return t.json({status:2003,dataL:e,msg:"服务器错误，请稍后重试！"})}))},O=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var a,s,o,u,i,c,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=t.body,s=a.name,o=a.userId,e.next=3,USER.findOne({_id:o});case 3:return u=e.sent,i=u.friendFenzu,c=Object.keys(i),d=null,d=c.includes(s)?i:Object.assign({},i,Object(n["a"])({},s,[])),e.next=10,USER.findByIdAndUpdate({_id:o},{$set:{friendFenzu:d}});case 10:return p=e.sent,e.abrupt("return",r.json({status:2e3,data:p,msg:"添加新分组成功"}));case 12:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),j=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,o,u,i,c;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.fenzuName,s=n.userId,e.next=3,USER.findOne({_id:s});case 3:return o=e.sent,u=o.friendFenzu,i=JSON.parse(JSON.stringify(u)),delete i[a],e.next=9,USER.findByIdAndUpdate({_id:s},{$set:{friendFenzu:i}});case 9:return c=e.sent,e.abrupt("return",r.json({status:2e3,data:c,msg:"删除成功！"}));case 11:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),T=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,o,u,i,c,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.oldFenzu,s=n.newFenzu,o=n.userId,e.next=3,USER.findOne({_id:o});case 3:return u=e.sent,i=u.friendFenzu,c=JSON.parse(JSON.stringify(i)),d=i[a],delete c[a],c[s]=d,e.next=11,USER.findByIdAndUpdate({_id:o},{$set:{friendFenzu:c}});case 11:return p=e.sent,e.abrupt("return",r.json({status:2e3,data:p,msg:"更新成功！"}));case 13:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),S=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,o,u,i,c,d,p,f,g;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.body,a=n.userId,s=n.friendId,o=n.newFenzu,e.next=3,USER.findOne({_id:a});case 3:for(d in u=e.sent,i=JSON.parse(JSON.stringify(u.friendFenzu)),c="",i)i.hasOwnProperty(d)&&(p=i[d],p.includes(s)&&(c=d));if(c!==o){e.next=9;break}return e.abrupt("return",r.json({status:2e3,data:"",msg:"已经在次分组"}));case 9:return c&&(f=i[c].findIndex((function(e){return e===s})),i[c].splice(f,1)),i[o].push(s),e.next=14,USER.findByIdAndUpdate({_id:a},{$set:{friendFenzu:i}});case 14:return g=e.sent,e.abrupt("return",r.json({status:2e3,data:g,msg:"跟新成功"}));case 16:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),M=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var a,s,o,u,i,c,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=t.body,s=a.userId,o=a.friendId,u=a.friendBeizhu,e.next=3,USER.findOne({_id:s});case 3:return i=e.sent,c=i.friendBeizhu,d=Object.assign({},c,Object(n["a"])({},o,u)),e.next=8,USER.findByIdAndUpdate({_id:s},{$set:{friendBeizhu:d}});case 8:return p=e.sent,e.abrupt("return",r.json({status:2e3,data:p,msg:"修改备注成功！"}));case 10:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),G=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=t.userId,n=t.time,e.next=4,USER.findByIdAndUpdate({_id:r},{$inc:{onlineTime:Number(n)}});case 4:return a=e.sent,e.abrupt("return",a);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),A=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var a,s,o,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,a=t.body,s=a.field,o=a.value,u=a.userId,parseToken(t.headers.authorization)===u){e.next=4;break}return e.abrupt("return",r.json({status:2001,data:[],msg:"错误操作！"}));case 4:return e.next=6,USER.findByIdAndUpdate({_id:u},Object(n["a"])({},s,o));case 6:return e.sent,e.abrupt("return",r.json({status:2e3,data:[],msg:"修改成功！"}));case 10:return e.prev=10,e.t0=e["catch"](0),e.abrupt("return",r.json({status:2003,data:e.t0,msg:"服务端错误！"}));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,r){return e.apply(this,arguments)}}(),U=function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,s,o,u,i,c,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,n=t.body,a=n.oldPwd,s=n.newPwd,o=n.reNewPwd,u=n.userId,e.next=4,USER.findOne({_id:u},{pass:1});case 4:if(i=e.sent,c=i.pass,d=md5(a),p=md5(s),parseToken(t.headers.authorization)===u){e.next=10;break}return e.abrupt("return",r.json({status:2001,data:[],msg:"错误操作！"}));case 10:if(c===d){e.next=12;break}return e.abrupt("return",r.json({status:2001,data:[],msg:"原始密码输入错误！"}));case 12:if(s===o){e.next=14;break}return e.abrupt("return",r.json({status:2001,data:[],msg:"两次密码不一致！"}));case 14:return e.next=16,USER.findByIdAndUpdate({_id:u},{pass:p});case 16:return e.sent,e.abrupt("return",r.json({status:2e3,data:[],msg:"更新成功，请牢记你的新密码！"}));case 20:return e.prev=20,e.t0=e["catch"](0),e.abrupt("return",r.json({status:2003,data:[],msg:"服务端错误！"}));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})));return function(t,r){return e.apply(this,arguments)}}();t["default"]={login:l,serviceInit:b,generatorCode:m,register:y,getUserInfo:w,preFetchUser:I,getAllUser:k,getUserBySignUpTime:x,changeUserStatus:R,addNewFenzu:O,deleteFenzu:j,editFenzu:T,modifyFrienFenzu:S,modifyBeizhu:M,updateUserOnlineTime:G,updateUserInfo:A,updateUserPwd:U,setUserAvatar:v}},e532:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));r("a15b"),r("1c46");function n(e){var t=/^(?!_)(?!.*?_$)[a-zA-Z0-9_\u4e00-\u9fa5]+$/;return 0!==e.length&&(!!t.test(e)&&!(e.length>9))}},e582:function(e,t,r){"use strict";(function(e){r("d81d"),r("d3b7"),r("07ac"),r("25f0"),r("3ca3"),r("ddb0");var n=r("b85c"),a=r("53ca"),s=(r("96cf"),r("1da1")),o=r("db6e"),u=(r("cfbb"),r("a090"),r("3f4c")),i=r("15a6"),c=r("4dec"),d=r("94f8"),p=r.n(d),f=r("6467"),g=(r("0613"),r("302f"),r("5ab6"),r("e532"),r("739d"),r("a002"),1e6),h={};var m=function(e){var t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(r)t=new o["MerkleTree"](e,p.a,{sortLeaves:!0,hashLeaves:!0});else{var n=e.map((function(e){return e.hash}));t=new o["MerkleTree"](n,p.a,{sortLeaves:!0})}var a=t.getRoot().toString("hex");return a},b=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r){var n,s,o,u,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!r){e.next=6;break}return e.next=3,i["a"].db.groupBlockRepository.where("[groupId+time]").between([t,c["a"].minKey],[t,r+1]).reverse().first();case 3:n=e.sent,e.next=9;break;case 6:return e.next=8,i["a"].db.groupBlockRepository.where("[groupId+time]").between([t,c["a"].minKey],[t,c["a"].maxKey]).reverse().first();case 8:n=e.sent;case 9:if(n){e.next=11;break}return e.abrupt("return");case 11:0,s=n,o=s.time,u=Date.now(),d=regeneratorRuntime.mark((function e(){var r,n,a,d,p,f,h,b;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,i["a"].db.groupMessageRepository.where(["groupId","time"]).between([t,o],[t,c["a"].maxKey]).first();case 2:if(r=e.sent,r){e.next=5;break}return e.abrupt("return",{v:void 0});case 5:if(n=(r.time-o-(r.time-o)%g)/g,o+=g*n,!(o>=u-g)){e.next=9;break}return e.abrupt("return","break");case 9:return a=o+g,e.next=12,i["a"].db.groupMessageRepository.where(["groupId","time"]).between([t,o],[t,a]).toArray();case 12:d=e.sent,d.length>0&&(p=m(d),d=d.map((function(e){return{content:d.content,groupId:d.groupId,hash:d.hash,height:d.height,messageType:d.messageType,signature:d.signature,time:d.time,userId:d.userId,width:d.width}})),f=s.number+1,h=i["a"].web3.eth.accounts.hashMessage(t+s.hash+f+a+p),b={groupId:t,preHash:s.hash,time:a,messageRoot:p,hash:h,number:f,messages:d},i["a"].db.groupBlockRepository.put(b),s=b);case 15:case"end":return e.stop()}}),e)}));case 16:if(!(o<u-g)){e.next=28;break}return e.delegateYield(d(),"t0",18);case 18:p=e.t0,e.t1=p,e.next="break"===e.t1?22:23;break;case 22:return e.abrupt("break",28);case 23:if("object"!==Object(a["a"])(p)){e.next=25;break}return e.abrupt("return",p.v);case 25:o+=g,e.next=16;break;case 28:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),l=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,i["a"].db.groupBlockRepository.where("[groupId+time]").between([t,c["a"].minKey],[t,c["a"].maxKey]).reverse().first();case 2:if(r=e.sent,!r){e.next=7;break}return e.abrupt("return",r);case 7:return e.abrupt("return",null);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n,a){var o,u,d,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:for(o=[],u=1;u<r;u++)o.push(a-u*n);return o.reverse(),d=o.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",i["a"].db.groupBlockRepository.where("[groupId+time]").between([t,r],[t,c["a"].maxKey]).first());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=6,Promise.all(d);case 6:return p=e.sent,e.abrupt("return",p);case 8:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}(),v=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n,a){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i["a"].roomObjects[t].syncRequest({messageType:"fetchRecentSkeleton",content:{currentBlock:n,requestSkeletonCount:a,requestSkeletonSkip:864e5}},r),e.abrupt("return",new Promise((function(e,n){h[t].deliverRecentBlocks[r]=e})));case 2:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}(),w=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i["a"].roomObjects[t].syncRequest({messageType:"fetchAllBlocks",content:{}},r),e.abrupt("return",new Promise((function(e,n){h[t].deliverAllBlocks[r]=e})));case 2:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),I=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i["a"].roomObjects[t].syncRequest({messageType:"fetchBlockByNumber",content:{number:n}},r),e.abrupt("return",new Promise((function(e,n){h[t].deliverBlock[r]=e})));case 2:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),k=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i["a"].roomObjects[t].syncRequest({messageType:"fetchAncestorNeighbors",content:{date:n}},r),e.abrupt("return",new Promise((function(e,n){h[t].deliverAncestorNeighbors[r]=e})));case 2:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),x=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n,a,s){var o,u,c,d,p,f,g,h,b;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:o={},o[r.address]=n,o[r.address].privateKey=r.privateKey,a.status="creator",o[a.userId]=a,u=Object.values(o),c=m(u,!0),d=[s],p=m(d),f=i["a"].web3.eth.accounts.hashMessage(""+r.address+0+n.createTime+p+c),g=i["a"].web3.eth.accounts.sign(f,t.privateKey),h=g.signature,b={groupId:r.address,preHash:"",time:n.createTime,number:0,hash:f,stateRoot:c,states:o,signature:h,messageRoot:p,messages:d},i["a"].db.groupBlockRepository.put(b);case 15:case"end":return e.stop()}}),e)})));return function(t,r,n,a,s){return e.apply(this,arguments)}}(),R=function(t){var r;try{r=i["a"].web3.eth.accounts.recover(t.hash,t.signature)}catch(s){return!1}var n=e.from(r+r+r+r,"utf-8"),a=f["a"].createIdentity(n);return a.address==t.groupId&&(i["a"].db.groupBlockRepository.put(t).then((function(){})),t.states[t.groupId].privateKey&&i["a"].db.groupRepository.where({groupId:t.groupId}).first().then((function(e){e.privateKey=t.states[t.groupId].privateKey,i["a"].db.groupRepository.put(e).then((function(){}))})),!0)},O=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r){var n,a,o,u,c,d,p,f,g,m,y,x,R,O,S,M,G,A,U,_,N,B,C,K;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return b(t),e.next=3,l(t);case 3:if(a=e.sent,!a){e.next=113;break}o=1,u=a.number,c=[];case 8:if(!(o<5)){e.next=45;break}return e.next=11,v(t,r,a,7*o);case 11:if(d=e.sent,1!=o){e.next=23;break}return e.next=16,i["a"].db.groupBlockRepository.where({hash:d[d.length-1].hash}).first();case 16:if(p=e.sent,!p){e.next=20;break}return e.abrupt("return");case 20:u=d[d.length-1].number;case 23:return f=d.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!t){e.next=4;break}return e.abrupt("return",i["a"].db.groupBlockRepository.where({hash:t.hash}).first());case 4:return e.abrupt("return",null);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=26,Promise.all(f);case 26:if(g=e.sent,!g[0]){e.next=42;break}m=1;case 29:if(!(m<g.length)){e.next=41;break}if(!g[m]){e.next=36;break}if(!(g[m].number<g[m-1].number)){e.next=33;break}return e.abrupt("return");case 33:c[0]=g[m].time,e.next=38;break;case 36:return c[1]=d[m].time+1,e.abrupt("break",41);case 38:m++,e.next=29;break;case 41:return e.abrupt("break",45);case 42:o++,e.next=8;break;case 45:return e.next=47,k(t,r,c);case 47:return y=e.sent,R=y.map(function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!t){e.next=4;break}return e.abrupt("return",i["a"].db.groupBlockRepository.where({hash:t.hash}).first());case 4:return e.abrupt("return",null);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=52,Promise.all(R);case 52:O=e.sent,e.t0=regeneratorRuntime.keys(O);case 54:if((e.t1=e.t0()).done){e.next=62;break}if(S=e.t1.value,O[S]){e.next=60;break}return x=O[S-1],e.abrupt("break",62);case 60:e.next=54;break;case 62:if(!h[t].forks[x.hash]){e.next=86;break}M=h[t].forks[x.hash].finishedHeight,G=0;case 66:if(!(M<u)){e.next=84;break}return e.next=69,I(t,r,M+1);case 69:if(A=e.sent,G++,!A){e.next=76;break}h[t].forks[x.hash].finishedBlock[A.hash]||(h[t].forks[x.hash].finishedBlock[A.hash]={preHash:A.preHash},h[t].forks[x.hash].finishedHeight=A.number,T(A)),e.next=77;break;case 76:return e.abrupt("break",84);case 77:if(M=h[t].forks[x.hash].finishedHeight,!(G>1e3)){e.next=82;break}return e.abrupt("break",84);case 82:e.next=66;break;case 84:e.next=111;break;case 86:U={},U[x.hash]={preHash:x.preHash},h[t].forks[x.hash]={finishedBlock:U,peerIds:[r],finishedHeight:x.number},_=h[t].forks[x.hash].finishedHeight,N=0;case 93:if(!(_<u)){e.next=111;break}return e.next=96,I(t,r,_+1);case 96:if(B=e.sent,N++,!B){e.next=103;break}h[t].forks[x.hash].finishedBlock[B.hash]||(h[t].forks[x.hash].finishedBlock[B.hash]={preHash:B.preHash},h[t].forks[x.hash].finishedHeight=B.number,T(B)),e.next=104;break;case 103:return e.abrupt("break",111);case 104:if(_=h[t].forks[x.hash].finishedHeight,!(N>1e3)){e.next=109;break}return e.abrupt("break",111);case 109:e.next=93;break;case 111:e.next=120;break;case 113:return e.next=115,w(t,r);case 115:return C=e.sent,e.next=118,j(C);case 118:K=e.sent,K&&(n=C[0].time);case 120:b(t,n);case 121:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),j=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(0!=t[0].number){e.next=4;break}if(R(t[0])){e.next=4;break}return e.abrupt("return",!1);case 4:r=Object(n["a"])(t),e.prev=5,r.s();case 7:if((a=r.n()).done){e.next=15;break}if(s=a.value,!T(s)){e.next=12;break}e.next=13;break;case 12:return e.abrupt("return",!1);case 13:e.next=7;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e["catch"](5),r.e(e.t0);case 20:return e.prev=20,r.f(),e.finish(20);case 23:return e.abrupt("return",!0);case 24:case"end":return e.stop()}}),e,null,[[5,17,20,23]])})));return function(t){return e.apply(this,arguments)}}(),T=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t){var r,a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(0!=t.number){e.next=4;break}if(R(t)){e.next=4;break}return e.abrupt("return",!1);case 4:r=Object(n["a"])(t.messages);try{for(r.s();!(a=r.n()).done;)s=a.value,u["default"].receiveGroupMessage(t.groupId,s,null)}catch(o){r.e(o)}finally{r.f()}return e.abrupt("return",!0);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),S=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n){var a,s,o,u,c;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!r.currentBlock){e.next=31;break}return e.next=3,l(t);case 3:if(a=e.sent,!a){e.next=29;break}if(a.hash!=r.currentBlock.hash){e.next=11;break}i["a"].roomObjects[t].syncRequest({messageType:"info",content:"synchronized"},n),e.next=27;break;case 11:return e.next=13,i["a"].db.groupBlockRepository.where({hash:r.currentBlock.hash}).first();case 13:if(s=e.sent,!s){e.next=22;break}return e.next=17,i["a"].db.groupBlockRepository.where({preHash:r.currentBlock.hash}).first();case 17:o=e.sent,u=[s,o],i["a"].roomObjects[t].syncRequest({messageType:"recentBlocks",content:u},n),e.next=27;break;case 22:return e.next=24,y(t,r.requestSkeletonCount,r.requestSkeletonSkip,(r.currentBlock.time<a.time?r.currentBlock.time:a.time)+1);case 24:c=e.sent,c.push(a),i["a"].roomObjects[t].syncRequest({messageType:"recentBlocks",content:c},n);case 27:e.next=31;break;case 29:i["a"].roomObjects[t].syncRequest({messageType:"info",content:"failed"},n);case 31:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),M=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n){var a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,l(t);case 3:if(a=e.sent,!a){e.next=12;break}return e.next=8,i["a"].db.groupBlockRepository.where("[groupId+time]").between([t,c["a"].minKey],[t,c["a"].maxKey]).toArray();case 8:s=e.sent,i["a"].roomObjects[t].syncRequest({messageType:"allBlocks",content:s},n),e.next=14;break;case 12:i["a"].roomObjects[t].syncRequest({messageType:"info",content:"failed"},n);case 14:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),G=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n){var a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,l(t);case 3:if(a=e.sent,!a){e.next=12;break}return e.next=8,i["a"].db.groupBlockRepository.where("[groupId+time]").between([t,r.date[0]],[t,r.date[1]]).toArray();case 8:s=e.sent,i["a"].roomObjects[t].syncRequest({messageType:"ancestorNeighbors",content:s},n),e.next=14;break;case 12:i["a"].roomObjects[t].syncRequest({messageType:"info",content:"failed"},n);case 14:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),A=function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,r,n){var a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=3,l(t);case 3:if(a=e.sent,!a){e.next=25;break}if(!h[t].limits[n]){e.next=17;break}if(!h[t].limits[n].block[r.number]){e.next=14;break}if(h[t].limits[n].block[r.number]=h[t].limits[n].block[r.number]+1,!(h[t].limits[n].block[r.number]>2)){e.next=12;break}return h[t].ban.push(n),e.abrupt("return");case 12:e.next=15;break;case 14:h[t].limits[n].block[r.number]=1;case 15:e.next=19;break;case 17:h[t].limits[n]={block:{}},h[t].limits[n].block[r.number]=1;case 19:return e.next=21,i["a"].db.groupBlockRepository.where("[groupId+number]").equals([t,r.number]).first();case 21:s=e.sent,i["a"].roomObjects[t].syncRequest({messageType:"block",content:s},n),e.next=27;break;case 25:i["a"].roomObjects[t].syncRequest({messageType:"info",content:"failed"},n);case 27:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}();t["a"]={syncTasks:h,updateChain:b,localCurrentBlock:l,sync:O,deliverRecentBlocksRequest:S,deliverAllBlocksRequest:M,generateGenesisBlock:x,deliverAncestorNeighborsRequest:G,deliverBlockByNumberRequest:A}}).call(this,r("b639").Buffer)},f71c:function(e,t,r){"use strict";r("96cf");var n=r("1da1"),a=r("99e5"),s=r.n(a),o=(r("cfbb"),r("a090"),r("15a6"),r("4dec"),r("0613"),r("302f"),r("5ab6"),r("739d"),r("a002"),new s.a(new s.a.providers.WebsocketProvider("wss://rinkeby.infura.io/ws/v3/a898a2d231e647c7928dc457c6d441c8"))),u=[{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"from",type:"address"},{indexed:!1,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"Give",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"sender",type:"address"},{indexed:!1,internalType:"address",name:"receiver",type:"address"},{indexed:!1,internalType:"uint256",name:"time",type:"uint256"}],name:"Read",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"sender",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"Require",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"from",type:"address"},{indexed:!1,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"string",name:"message",type:"string"}],name:"Send",type:"event"},{inputs:[{internalType:"address",name:"",type:"address"}],name:"accounts",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"receiver",type:"address"}],name:"giveETH",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"},{internalType:"address",name:"",type:"address"}],name:"lenghth",outputs:[{internalType:"uint32",name:"",type:"uint32"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"},{internalType:"address",name:"",type:"address"},{internalType:"uint256",name:"",type:"uint256"}],name:"messages",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"sender",type:"address"}],name:"readMessage",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"uint256",name:"amount",type:"uint256"}],name:"requireETH",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"receiver",type:"address"},{internalType:"string",name:"message",type:"string"}],name:"sendMessage",outputs:[],stateMutability:"nonpayable",type:"function"}],i="0xDbC0671B828485EB1d9b18bC17dE1ecCb528686A",c=new o.eth.Contract(u);c.options.address=i;var d={},p=0,f=function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(t,r,n,a){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(a=JSON.stringify(a),""==t){e.next=10;break}return d.privateKey=r,e.next=6,c.methods.sendMessage(t,a).estimateGas({from:t});case 6:p=e.sent,c.methods.sendMessage(n,a).send({from:t}).on("sending",h),e.next=14;break;case 10:return e.next=12,c.methods.sendMessage(n,a).send({from:t});case 12:e.sent;case 14:case"end":return e.stop()}}),e)})));return function(t,r,n,a){return e.apply(this,arguments)}}(),g=function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:o.eth.accounts.signTransaction({to:r,value:n,gas:21e3},t).then(m);case 2:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}();function h(e){var t=e.params[0];t.gas=p,t["chain"]="rinkeby",t["hardfork"]="constantinople",o.eth.accounts.signTransaction(t,d.privateKey).then(m)}function m(e){var t=e.rawTransaction;o.eth.sendSignedTransaction(t).then((function(e){}))}var b=function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(t,r,n){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,c.methods.messages(t,r,n).call();case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}();t["a"]={sendMessage:f,sendFund:g,acquireMessage:b}}});